<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=2"><meta name="theme-color" content="#FFF"><link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png"><link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="alternate" type="application/rss+xml" title="XYK的博客" href="https://ks-superbig.github.io/rss.xml"><link rel="alternate" type="application/atom+xml" title="XYK的博客" href="https://ks-superbig.github.io/atom.xml"><link rel="alternate" type="application/json" title="XYK的博客" href="https://ks-superbig.github.io/feed.json"><link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext"><link rel="stylesheet" href="/css/app.css?v=0.2.5"><link rel="canonical" href="https://ks-superbig.github.io/2025/08/02/CSAPP/"><title>CSAPP | XYK的博客 = XYK的博客</title><meta name="generator" content="Hexo 7.3.0"></head><body itemscope itemtype="http://schema.org/WebPage"><div id="loading"><div class="loader-wrapper"><span class="loader-letter">G</span> <span class="loader-letter">e</span> <span class="loader-letter">n</span> <span class="loader-letter">e</span> <span class="loader-letter">r</span> <span class="loader-letter">a</span> <span class="loader-letter">t</span> <span class="loader-letter">i</span> <span class="loader-letter">n</span> <span class="loader-letter">g</span><div class="loader"></div></div></div><div id="container"><header id="header" itemscope itemtype="http://schema.org/WPHeader"><div class="inner"><div id="brand"><div class="pjax"><h1 itemprop="name headline">CSAPP</h1><div class="meta"><span class="item" title="Created: 2025-08-02 19:39:29"><span class="icon"><i class="ic i-calendar"></i> </span><span class="text">Posted on</span> <time itemprop="dateCreated datePublished" datetime="2025-08-02T19:39:29+08:00">2025-08-02</time></span></div></div></div><nav id="nav"><div class="inner"><div class="toggle"><div class="lines" aria-label="Toggle navigation bar"><span class="line"></span> <span class="line"></span> <span class="line"></span></div></div><ul class="menu"><li class="item title"><a href="/" rel="start">XYK的博客</a></li><li class="item"><a href="/cs/"><i class="ic i-computer"></i> CS杂记</a></li><li class="item"><a href="/photo/"><i class="ic i-camera"></i> Photo随拍</a></li><li class="item"><a href="/profile/"><i class="ic i-user"></i> Profile</a></li></ul><ul class="right"><li class="item theme"><i class="ic i-sun"></i></li><li class="item search"><i class="ic i-search"></i></li></ul></div></nav></div><div id="imgs" class="pjax"><ul><li class="item" data-background-image="/images/cover.jpg"></li><li class="item" data-background-image="/images/cover.jpg"></li><li class="item" data-background-image="/images/cover.jpg"></li><li class="item" data-background-image="/images/cover.jpg"></li><li class="item" data-background-image="/images/cover.jpg"></li><li class="item" data-background-image="/images/cover.jpg"></li></ul></div></header><div id="waves"><svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto"><defs><path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"/></defs><g class="parallax"><use xlink:href="#gentle-wave" x="48" y="0"/><use xlink:href="#gentle-wave" x="48" y="3"/><use xlink:href="#gentle-wave" x="48" y="5"/><use xlink:href="#gentle-wave" x="48" y="7"/></g></svg></div><main><div class="inner"><div id="main" class="pjax"><div class="article wrap"><div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList"><i class="ic i-home"></i> <span><a href="/">Home</a></span></div><article itemscope itemtype="http://schema.org/Article" class="post block" lang="en"><link itemprop="mainEntityOfPage" href="https://ks-superbig.github.io/2025/08/02/CSAPP/"><span hidden itemprop="author" itemscope itemtype="http://schema.org/Person"><meta itemprop="image" content="/images/avatar.jpg"><meta itemprop="name" content="XYK"><meta itemprop="description" content=", "></span><span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization"><meta itemprop="name" content="XYK的博客"></span><div class="body md" itemprop="articleBody"><h1 id="csapp"><a class="anchor" href="#csapp">#</a> CSAPP</h1><h2 id="labs"><a class="anchor" href="#labs">#</a> labs</h2><h3 id="bomb"><a class="anchor" href="#bomb">#</a> bomb</h3><p>phase_1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">00000000000012db &lt;phase_1&gt;:</span><br><span class="line">    12db:       48 83 ec 08             sub    $0x8,%rsp      </span><br><span class="line">    12df:       48 8d 35 7a 18 00 00    lea    0x187a(%rip),%rsi        # 2b60 &lt;_IO_stdin_used+0x150&gt;</span><br><span class="line">    12e6:       e8 62 05 00 00          callq  184d &lt;strings_not_equal&gt;//上面的rsi是第二个参数，rdi是第一个参                                                                          数</span><br><span class="line">    12eb:       85 c0                   test   %eax,%eax   //返回值如果是1那么ZF为0那么test结果为假，则爆炸</span><br><span class="line">    12ed:       74 05                   je     12f4 &lt;phase_1+0x19&gt;  //只有返回值0即两个部分相等才可以跳转</span><br><span class="line">    12ef:       e8 58 08 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line">    12f4:       48 83 c4 08             add    $0x8,%rsp</span><br><span class="line">    12f8:       c3                      retq</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>phase_2：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">00000000000012f9 &lt;phase_2&gt;:</span><br><span class="line">    12f9:       55                      push   %rbp</span><br><span class="line">    12fa:       53                      push   %rbx</span><br><span class="line">    12fb:       48 83 ec 28             sub    $0x28,%rsp</span><br><span class="line">    12ff:       64 48 8b 04 25 28 00    mov    %fs:0x28,%rax</span><br><span class="line">    1306:       00 00</span><br><span class="line">    1308:       48 89 44 24 18          mov    %rax,0x18(%rsp)</span><br><span class="line">    130d:       31 c0                   xor    %eax,%eax   //一个清零操作</span><br><span class="line">    130f:       48 89 e6                mov    %rsp,%rsi</span><br><span class="line">    1312:       e8 71 08 00 00          callq  1b88 &lt;read_six_numbers&gt; </span><br><span class="line">    1317:       83 3c 24 00             cmpl   $0x0,(%rsp)</span><br><span class="line">    131b:       79 05                   jns    1322 &lt;phase_2+0x29&gt;  //cmpl，jns这个组合的作用是检查是否为非负                                                                       数，&gt;=0则跳转1322处mov否则爆炸</span><br><span class="line">    131d:       e8 2a 08 00 00          callq  1b4c &lt;explode_bomb&gt;  </span><br><span class="line">    1322:       48 89 e5                mov    %rsp,%rbp     //rbp中存储当前rsp中的数字</span><br><span class="line">    1325:       bb 01 00 00 00          mov    $0x1,%ebx   //ebx中设置为1</span><br><span class="line">  * 132a:       89 d8                   mov    %ebx,%eax   //令eax=1</span><br><span class="line">    132c:       03 45 00                add    0x0(%rbp),%eax   //eax+=rbp中的值也就是现在rsp所指的值</span><br><span class="line">    132f:       39 45 04                cmp    %eax,0x4(%rbp)   //比较eax和rbp地址增加四个字节后所对应的值</span><br><span class="line">                                                                  相等则跳转否则爆炸，这里的意思rbp加四个字节后                                                                   得到的值应该等于原先+eax 	</span><br><span class="line">    1332:       74 05                   je     1339 &lt;phase_2+0x40&gt;</span><br><span class="line">    1334:       e8 13 08 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line">    1339:       83 c3 01                add    $0x1,%ebx   //ebx=2现在</span><br><span class="line">    133c:       48 83 c5 04             add    $0x4,%rbp   //rbp向上移动四个字节</span><br><span class="line">  * 1340:       83 fb 06                cmp    $0x6,%ebx   //比较ebx和6不相等时跳转，到132a，从这里我们可以看出                                                              这是个循环</span><br><span class="line">    1343:       75 e5                   jne    132a &lt;phase_2+0x31&gt;</span><br><span class="line">    1345:       48 8b 44 24 18          mov    0x18(%rsp),%rax  //接下来这部分就是金丝雀的判断栈是否溢出部分</span><br><span class="line">    134a:       64 48 33 04 25 28 00    xor    %fs:0x28,%rax</span><br><span class="line">    1351:       00 00</span><br><span class="line">    1353:       74 05                   je     135a &lt;phase_2+0x61&gt;</span><br><span class="line">    1355:       e8 a6 fb ff ff          callq  f00 &lt;__stack_chk_fail@plt&gt;  </span><br><span class="line">    135a:       48 83 c4 28             add    $0x28,%rsp</span><br><span class="line">    135e:       5b                      pop    %rbx</span><br><span class="line">**表示循环内部</span><br></pre></td></tr></table></figure><p>phase_3：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"> 0000000000001361 &lt;phase_3&gt;:</span><br><span class="line"> 1361:       48 83 ec 28             sub    $0x28,%rsp</span><br><span class="line"> 1365:       64 48 8b 04 25 28 00    mov    %fs:0x28,%rax  //设置金丝雀</span><br><span class="line"> 136c:       00 00</span><br><span class="line"> 136e:       48 89 44 24 18          mov    %rax,0x18(%rsp)</span><br><span class="line"> 1373:       31 c0                   xor    %eax,%eax</span><br><span class="line"> 1375:       48 8d 4c 24 0f          lea    0xf(%rsp),%rcx  //一个字节</span><br><span class="line"> 137a:       48 8d 54 24 10          lea    0x10(%rsp),%rdx  //4个字节</span><br><span class="line"> 137f:       4c 8d 44 24 14          lea    0x14(%rsp),%r8   //四个字节</span><br><span class="line"> 1384:       48 8d 35 4b 18 00 00    lea    0x184b(%rip),%rsi        # 2bd6 &lt;_IO_stdin_used+0x1c6&gt;</span><br><span class="line"> 138b:       e8 10 fc ff ff          callq  fa0 &lt;__isoc99_sscanf@plt&gt;   //这几个lea不太好理解</span><br><span class="line"> 1390:       83 f8 02                cmp    $0x2,%eax   //函数的返回值和2比较如果eax-2&gt;0时跳转，否则爆炸也就                                                              是说我们要输入&gt;=2个数字</span><br><span class="line"> 1393:       7f 05                   jg     139a &lt;phase_3+0x39&gt;</span><br><span class="line"> 1395:       e8 b2 07 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line"> 139a:       83 7c 24 10 07          cmpl   $0x7,0x10(%rsp)   //也就是rdx中存储的值</span><br><span class="line"> 139f:       0f 87 02 01 00 00       ja     14a7 &lt;phase_3+0x146&gt; //如果大于7则跳转到那个地址处对应下面*号爆                                                                       炸，所以rdx中的值要&lt;=7</span><br><span class="line"> 13a5:       8b 54 24 10             mov    0x10(%rsp),%edx       //rdx中的值赋值到edx中</span><br><span class="line"> 13a9:       48 8d 05 40 18 00 00    lea    0x1840(%rip),%rax        # 2bf0 &lt;_IO_stdin_used+0x1e0&gt;</span><br><span class="line"> 13b0:       48 63 14 90             movslq (%rax,%rdx,4),%rdx   //rdx中的值经过寻址然后覆盖掉，并进行扩充</span><br><span class="line"> 13b4:       48 01 d0                add    %rdx,%rax     //rax=rax初始+rdx中的值</span><br><span class="line"> 13b7:       ff e0                   jmpq   *%rax   //将rax中的值当作地址跳转到这里，这里我们可以看出来是一个跳                                                          转表格式，下面也可以看到case有7个所以就是对应上面rdx&lt;=7</span><br><span class="line"> 13b9:       b8 63 00 00 00          mov    $0x63,%eax  //赋值</span><br><span class="line"> 13be:       81 7c 24 14 dd 03 00    cmpl   $0x3dd,0x14(%rsp)  //比较r8中的值和989，所以r8中为989</span><br><span class="line"> 13c5:       00</span><br><span class="line"> 13c6:       0f 84 e5 00 00 00       je     14b1 &lt;phase_3+0x150&gt;   //如果相等跳转不等就爆炸，所以我们可以有                                                                         一组答案就是0  989</span><br><span class="line"> 13cc:       e8 7b 07 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line"></span><br><span class="line"> 13e7:       00</span><br><span class="line"> 13e8:       0f 84 c3 00 00 00       je     14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 13ee:       e8 59 07 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line"> 13f3:       b8 63 00 00 00          mov    $0x63,%eax</span><br><span class="line"> 13f8:       e9 b4 00 00 00          jmpq   14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 13fd:       b8 6a 00 00 00          mov    $0x6a,%eax</span><br><span class="line"> 1402:       81 7c 24 14 3c 03 00    cmpl   $0x33c,0x14(%rsp)</span><br><span class="line"> 1409:       00</span><br><span class="line"> 140a:       0f 84 a1 00 00 00       je     14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 1410:       e8 37 07 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line"> 1415:       b8 6a 00 00 00          mov    $0x6a,%eax</span><br><span class="line"> 141a:       e9 92 00 00 00          jmpq   14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 141f:       b8 6a 00 00 00          mov    $0x6a,%eax</span><br><span class="line"> 1424:       83 7c 24 14 69          cmpl   $0x69,0x14(%rsp)</span><br><span class="line"> 1429:       0f 84 82 00 00 00       je     14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 142f:       e8 18 07 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line"> 1434:       b8 6a 00 00 00          mov    $0x6a,%eax</span><br><span class="line"> 1439:       eb 76                   jmp    14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 143b:       b8 69 00 00 00          mov    $0x69,%eax</span><br><span class="line"> 1440:       81 7c 24 14 6f 02 00    cmpl   $0x26f,0x14(%rsp)</span><br><span class="line"> 1447:       00</span><br><span class="line"> 1448:       74 67                   je     14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 144a:       e8 fd 06 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line"> 144f:       b8 69 00 00 00          mov    $0x69,%eax</span><br><span class="line"> 1454:       eb 5b                   jmp    14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 1456:       b8 6e 00 00 00          mov    $0x6e,%eax</span><br><span class="line"> 145b:       81 7c 24 14 b6 03 00    cmpl   $0x3b6,0x14(%rsp)</span><br><span class="line"> 1462:       00</span><br><span class="line"> 1463:       74 4c                   je     14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 1465:       e8 e2 06 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line"> 146a:       b8 6e 00 00 00          mov    $0x6e,%eax</span><br><span class="line"> 146f:       eb 40                   jmp    14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 1471:       b8 64 00 00 00          mov    $0x64,%eax</span><br><span class="line"> 1476:       81 7c 24 14 b3 03 00    cmpl   $0x3b3,0x14(%rsp)</span><br><span class="line"> 147d:       00</span><br><span class="line"> 147e:       74 31                   je     14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 1480:       e8 c7 06 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line"> 1485:       b8 64 00 00 00          mov    $0x64,%eax</span><br><span class="line"> 148a:       eb 25                   jmp    14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 148c:       b8 6b 00 00 00          mov    $0x6b,%eax</span><br><span class="line"> 1491:       81 7c 24 14 da 03 00    cmpl   $0x3da,0x14(%rsp)</span><br><span class="line"> 1498:       00</span><br><span class="line"> 1499:       74 16                   je     14b1 &lt;phase_3+0x150&gt;</span><br><span class="line"> 149b:       e8 ac 06 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line"> 14a0:       b8 6b 00 00 00          mov    $0x6b,%eax</span><br><span class="line"> 14a5:       eb 0a                   jmp    14b1 &lt;phase_3+0x150&gt;</span><br><span class="line">*14a7:       e8 a0 06 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line"> 14ac:       b8 78 00 00 00          mov    $0x78,%eax</span><br><span class="line">*14b1:       3a 44 24 0f             cmp    0xf(%rsp),%al    </span><br><span class="line"> 14b5:       74 05                   je     14bc &lt;phase_3+0x15b&gt;</span><br><span class="line"> 14b7:       e8 90 06 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line"> 14bc:       48 8b 44 24 18          mov    0x18(%rsp),%rax</span><br><span class="line"> 14c1:       64 48 33 04 25 28 00    xor    %fs:0x28,%rax</span><br><span class="line"> 14c8:       00 00</span><br><span class="line"> 14ca:       74 05                   je     14d1 &lt;phase_3+0x170&gt;</span><br><span class="line"> 14cc:       e8 2f fa ff ff          callq  f00 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line"> 14d1:       48 83 c4 28             add    $0x28,%rsp</span><br><span class="line"> 14d5:       c3                      retq</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>phase_4</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">0000000000001514 &lt;phase_4&gt;:</span><br><span class="line">    1514:       48 83 ec 18             sub    $0x18,%rsp</span><br><span class="line">    1518:       64 48 8b 04 25 28 00    mov    %fs:0x28,%rax</span><br><span class="line">    151f:       00 00</span><br><span class="line">    1521:       48 89 44 24 08          mov    %rax,0x8(%rsp)   </span><br><span class="line">    1526:       31 c0                   xor    %eax,%eax    //经典操作设置金丝雀，并且置0</span><br><span class="line">    1528:       48 8d 4c 24 04          lea    0x4(%rsp),%rcx    </span><br><span class="line">    152d:       48 89 e2                mov    %rsp,%rdx</span><br><span class="line">    1530:       48 8d 35 36 19 00 00    lea    0x1936(%rip),%rsi        # 2e6d &lt;array.3462+0x25d&gt;</span><br><span class="line">    1537:       e8 64 fa ff ff          callq  fa0 &lt;__isoc99_sscanf@plt&gt;</span><br><span class="line">    153c:       83 f8 02                cmp    $0x2,%eax </span><br><span class="line">    153f:       75 06                   jne    1547 &lt;phase_4+0x33&gt; //不相等跳转爆炸，所以eax为2，那么就是2个数</span><br><span class="line">    1541:       83 3c 24 0e             cmpl   $0xe,(%rsp)//rsp中的值-14&lt;=0那么跳转，这里需要跳转因为要不会爆炸</span><br><span class="line">    1545:       76 05                   jbe    154c &lt;phase_4+0x38&gt;</span><br><span class="line">   *1547:       e8 00 06 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line">   *154c:       ba 0e 00 00 00          mov    $0xe,%edx  //edx=14</span><br><span class="line">    1551:       be 00 00 00 00          mov    $0x0,%esi  //esi=0</span><br><span class="line">    1556:       8b 3c 24                mov    (%rsp),%edi  //edi=（rsp）此处的值并且进行func的参数</span><br><span class="line">    1559:       e8 78 ff ff ff          callq  14d6 &lt;func4&gt;   //这里还需要看一下func4</span><br><span class="line">    155e:       85 c0                   test   %eax,%eax</span><br><span class="line">    1560:       75 07                   jne    1569 &lt;phase_4+0x55&gt;  //所以函数的返回值必须是0</span><br><span class="line">    1562:       83 7c 24 04 00          cmpl   $0x0,0x4(%rsp)  //rcx中的值必须是0，否则爆炸</span><br><span class="line">    1567:       74 05                   je     156e &lt;phase_4+0x5a&gt;  </span><br><span class="line">  * 1569:       e8 de 05 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line">    156e:       48 8b 44 24 08          mov    0x8(%rsp),%rax</span><br><span class="line">    1573:       64 48 33 04 25 28 00    xor    %fs:0x28,%rax</span><br><span class="line">    157a:       00 00</span><br><span class="line">    157c:       74 05                   je     1583 &lt;phase_4+0x6f&gt;</span><br><span class="line">    157e:       e8 7d f9 ff ff          callq  f00 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">    1583:       48 83 c4 18             add    $0x18,%rsp</span><br><span class="line">    1587:       c3                      retq</span><br><span class="line"></span><br><span class="line">00000000000014d6 &lt;func4&gt;:</span><br><span class="line">    14d6:       48 83 ec 08             sub    $0x8,%rsp</span><br><span class="line">    14da:       89 d0                   mov    %edx,%eax  //eax=edx=14</span><br><span class="line">    14dc:       29 f0                   sub    %esi,%eax  //eax-=esi</span><br><span class="line">    14de:       89 c1                   mov    %eax,%ecx  //ecx=eax</span><br><span class="line">    14e0:       c1 e9 1f                shr    $0x1f,%ecx  //逻辑右移ecx31，也就是只剩下符号位</span><br><span class="line">    14e3:       01 c8                   add    %ecx,%eax   //eax+=ecx原来的符号位</span><br><span class="line">    14e5:       d1 f8                   sar    %eax  //eax算术右移一位，这里其实就是找中间值</span><br><span class="line">    14e7:       8d 0c 30                lea    (%rax,%rsi,1),%ecx  //ecx存储rax+rsi所代表的地址</span><br><span class="line">    14ea:       39 f9                   cmp    %edi,%ecx  //ecx-edi&lt;=0跳转，中间值小于等于目标值就跳转</span><br><span class="line">    14ec:       7e 0c                   jle    14fa &lt;func4+0x24&gt;   </span><br><span class="line">    14ee:       8d 51 ff                lea    -0x1(%rcx),%edx  //否则rcx-1所指的地址存在edx中</span><br><span class="line">    14f1:       e8 e0 ff ff ff          callq  14d6 &lt;func4&gt;</span><br><span class="line">    14f6:       01 c0                   add    %eax,%eax   //eax*=2</span><br><span class="line">    14f8:       eb 15                   jmp    150f &lt;func4+0x39&gt;</span><br><span class="line">   *14fa:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">    14ff:       39 f9                   cmp    %edi,%ecx</span><br><span class="line">    1501:       7d 0c                   jge    150f &lt;func4+0x39&gt;    //大于等于mid就跳转尾部返回</span><br><span class="line">    1503:       8d 71 01                lea    0x1(%rcx),%esi</span><br><span class="line">    1506:       e8 cb ff ff ff          callq  14d6 &lt;func4&gt;</span><br><span class="line">    150b:       8d 44 00 01             lea    0x1(%rax,%rax,1),%eax</span><br><span class="line">   *150f:       48 83 c4 08             add    $0x8,%rsp</span><br><span class="line">    1513:       c3                      retq</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>phase_5</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">0000000000001588 &lt;phase_5&gt;:</span><br><span class="line">    1588:       53                      push   %rbx</span><br><span class="line">    1589:       48 83 ec 10             sub    $0x10,%rsp</span><br><span class="line">    158d:       48 89 fb                mov    %rdi,%rbx   //rdi中的值存入rbx</span><br><span class="line">    1590:       64 48 8b 04 25 28 00    mov    %fs:0x28,%rax</span><br><span class="line">    1597:       00 00</span><br><span class="line">    1599:       48 89 44 24 08          mov    %rax,0x8(%rsp)</span><br><span class="line">    159e:       31 c0                   xor    %eax,%eax</span><br><span class="line">    15a0:       e8 8a 02 00 00          callq  182f &lt;string_length&gt;</span><br><span class="line">    15a5:       83 f8 06                cmp    $0x6,%eax</span><br><span class="line">    15a8:       74 05                   je     15af &lt;phase_5+0x27&gt; //必须跳转否则爆炸，也就是返回字符串长度为6</span><br><span class="line">    15aa:       e8 9d 05 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line">   *15af:       b8 00 00 00 00          mov    $0x0,%eax    //eax赋值为0</span><br><span class="line">+2c 15b4:       0f b6 14 03             movzbl (%rbx,%rax,1),%edx   //从地址rbx+rax中取低八位数字存到edx中</span><br><span class="line">    15b8:       83 e2 0f                and    $0xf,%edx  //低四位和1进行与运算高位全部置为0</span><br><span class="line">    15bb:       48 8d 0d 4e 16 00 00    lea    0x164e(%rip),%rcx        # 2c10 &lt;array.3462&gt;</span><br><span class="line">    15c2:       0f b6 14 11             movzbl (%rcx,%rdx,1),%edx  //从一个地址读取一个字节存入edx</span><br><span class="line">    15c6:       88 54 04 01             mov    %dl,0x1(%rsp,%rax,1)  //将上一步操作的低八位放在后面所指向的地址</span><br><span class="line">    15ca:       48 83 c0 01             add    $0x1,%rax  //rax++</span><br><span class="line">    15ce:       48 83 f8 06             cmp    $0x6,%rax  //rax和6比较</span><br><span class="line">    15d2:       75 e0                   jne    15b4 &lt;phase_5+0x2c&gt;  //经历六轮循环</span><br><span class="line">    15d4:       c6 44 24 07 00          movb   $0x0,0x7(%rsp)  //</span><br><span class="line">    15d9:       48 8d 7c 24 01          lea    0x1(%rsp),%rdi</span><br><span class="line">    15de:       48 8d 35 fa 15 00 00    lea    0x15fa(%rip),%rsi        # 2bdf &lt;_IO_stdin_used+0x1cf&gt;</span><br><span class="line">    15e5:       e8 63 02 00 00          callq  184d &lt;strings_not_equal&gt;</span><br><span class="line">    15ea:       85 c0                   test   %eax,%eax    //返回值不为0那么就爆炸，也就是两个字符串需要相等</span><br><span class="line">    15ec:       74 05                   je     15f3 &lt;phase_5+0x6b&gt;</span><br><span class="line">    15ee:       e8 59 05 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line">+6b 15f3:       48 8b 44 24 08          mov    0x8(%rsp),%rax</span><br><span class="line">    15f8:       64 48 33 04 25 28 00    xor    %fs:0x28,%rax</span><br><span class="line">    15ff:       00 00</span><br><span class="line">    1601:       74 05                   je     1608 &lt;phase_5+0x80&gt;</span><br><span class="line">    1603:       e8 f8 f8 ff ff          callq  f00 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">    1608:       48 83 c4 10             add    $0x10,%rsp</span><br><span class="line">    160c:       5b                      pop    %rbx</span><br><span class="line">    160d:       c3                      retq</span><br><span class="line"></span><br><span class="line">000000000000182f &lt;string_length&gt;:</span><br><span class="line">    182f:       80 3f 00                cmpb   $0x0,(%rdi)  </span><br><span class="line">    1832:       74 13                   je     1847 &lt;string_length+0x18&gt;</span><br><span class="line">    1834:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">   *1839:       48 83 c7 01             add    $0x1,%rdi  //rdi++</span><br><span class="line">    183d:       83 c0 01                add    $0x1,%eax  //eax++</span><br><span class="line">    1840:       80 3f 00                cmpb   $0x0,(%rdi)  //rdi和0比较不相等就跳转</span><br><span class="line">    1843:       75 f4                   jne    1839 &lt;string_length+0xa&gt; </span><br><span class="line">    1845:       f3 c3                   repz retq</span><br><span class="line">   *1847:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">    184c:       c3                      retq</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>phase_6</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line">000000000000160e &lt;phase_6&gt;:</span><br><span class="line">    160e:       41 55                   push   %r13</span><br><span class="line">    1610:       41 54                   push   %r12</span><br><span class="line">    1612:       55                      push   %rbp</span><br><span class="line">    1613:       53                      push   %rbx</span><br><span class="line">    1614:       48 83 ec 68             sub    $0x68,%rsp</span><br><span class="line">    1618:       64 48 8b 04 25 28 00    mov    %fs:0x28,%rax</span><br><span class="line">    161f:       00 00</span><br><span class="line">    1621:       48 89 44 24 58          mov    %rax,0x58(%rsp)</span><br><span class="line">    1626:       31 c0                   xor    %eax,%eax</span><br><span class="line">    1628:       49 89 e4                mov    %rsp,%r12</span><br><span class="line">    162b:       48 89 e6                mov    %rsp,%rsi</span><br><span class="line">    162e:       e8 55 05 00 00          callq  1b88 &lt;read_six_numbers&gt;</span><br><span class="line">    1633:       41 bd 00 00 00 00       mov    $0x0,%r13d  </span><br><span class="line">    1639:       4c 89 e5                mov    %r12,%rbp    </span><br><span class="line">    163c:       41 8b 04 24             mov    (%r12),%eax</span><br><span class="line">    1640:       83 e8 01                sub    $0x1,%eax</span><br><span class="line">    1643:       83 f8 05                cmp    $0x5,%eax </span><br><span class="line">    1646:       76 05                   jbe    164d &lt;phase_6+0x3f&gt;  //必须小于等于否则爆炸</span><br><span class="line">    1648:       e8 ff 04 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line"> *  164d:       41 83 c5 01             add    $0x1,%r13d</span><br><span class="line">    1651:       41 83 fd 06             cmp    $0x6,%r13d     </span><br><span class="line">    1655:       74 3d                   je     1694 &lt;phase_6+0x86&gt;  </span><br><span class="line">    1657:       44 89 eb                mov    %r13d,%ebx   </span><br><span class="line">    165a:       48 63 c3                movslq %ebx,%rax</span><br><span class="line">    165d:       8b 04 84                mov    (%rsp,%rax,4),%eax  //第i个输入</span><br><span class="line">    1660:       39 45 00                cmp    %eax,0x0(%rbp)   //检查是否重复重复爆炸</span><br><span class="line">    1663:       75 05                   jne    166a &lt;phase_6+0x5c&gt;</span><br><span class="line">    1665:       e8 e2 04 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line">    166a:       83 c3 01                add    $0x1,%ebx</span><br><span class="line">    166d:       83 fb 05                cmp    $0x5,%ebx</span><br><span class="line">    1670:       7e e8                   jle    165a &lt;phase_6+0x4c&gt;</span><br><span class="line">    1672:       49 83 c4 04             add    $0x4,%r12</span><br><span class="line">    1676:       eb c1                   jmp    1639 &lt;phase_6+0x2b&gt;</span><br><span class="line">    1678:       48 8b 52 08             mov    0x8(%rdx),%rdx</span><br><span class="line">    167c:       83 c0 01                add    $0x1,%eax</span><br><span class="line">    167f:       39 c8                   cmp    %ecx,%eax</span><br><span class="line">    1681:       75 f5                   jne    1678 &lt;phase_6+0x6a&gt;</span><br><span class="line">    1683:       48 89 54 74 20          mov    %rdx,0x20(%rsp,%rsi,2)</span><br><span class="line">    1688:       48 83 c6 04             add    $0x4,%rsi</span><br><span class="line">    168c:       48 83 fe 18             cmp    $0x18,%rsi</span><br><span class="line">    1690:       75 07                   jne    1699 &lt;phase_6+0x8b&gt;</span><br><span class="line">    1692:       eb 1b                   jmp    16af &lt;phase_6+0xa1&gt;</span><br><span class="line">  * 1694:       be 00 00 00 00          mov    $0x0,%esi</span><br><span class="line">    1699:       8b 0c 34                mov    (%rsp,%rsi,1),%ecx</span><br><span class="line">    169c:       b8 01 00 00 00          mov    $0x1,%eax</span><br><span class="line">    16a1:       48 8d 15 88 2b 20 00    lea    0x202b88(%rip),%rdx        # 204230 &lt;node1&gt;</span><br><span class="line">    16a8:       83 f9 01                cmp    $0x1,%ecx</span><br><span class="line">    16ab:       7f cb                   jg     1678 &lt;phase_6+0x6a&gt;</span><br><span class="line">    16ad:       eb d4                   jmp    1683 &lt;phase_6+0x75&gt;</span><br><span class="line">    16af:       48 8b 5c 24 20          mov    0x20(%rsp),%rbx</span><br><span class="line">    16b4:       48 8d 44 24 20          lea    0x20(%rsp),%rax</span><br><span class="line">    16b9:       48 8d 74 24 48          lea    0x48(%rsp),%rsi</span><br><span class="line">    16be:       48 89 d9                mov    %rbx,%rcx</span><br><span class="line">    16c1:       48 8b 50 08             mov    0x8(%rax),%rdx</span><br><span class="line">    16c5:       48 89 51 08             mov    %rdx,0x8(%rcx)</span><br><span class="line">    16c9:       48 83 c0 08             add    $0x8,%rax</span><br><span class="line">    16cd:       48 89 d1                mov    %rdx,%rcx</span><br><span class="line">    16d0:       48 39 f0                cmp    %rsi,%rax</span><br><span class="line">    16d3:       75 ec                   jne    16c1 &lt;phase_6+0xb3&gt;</span><br><span class="line">    16d5:       48 c7 42 08 00 00 00    movq   $0x0,0x8(%rdx)</span><br><span class="line">    16dc:       00</span><br><span class="line">    16dd:       bd 05 00 00 00          mov    $0x5,%ebp</span><br><span class="line">    16e2:       48 8b 43 08             mov    0x8(%rbx),%rax    </span><br><span class="line">    16e6:       8b 00                   mov    (%rax),%eax       //选择下一个链表的操作</span><br><span class="line">    16e8:       39 03                   cmp    %eax,(%rbx)</span><br><span class="line">    16ea:       7e 05                   jle    16f1 &lt;phase_6+0xe3&gt;   //这句话就是说node必须是降序排列的，否则就                                                                          会爆炸</span><br><span class="line">    16ec:       e8 5b 04 00 00          callq  1b4c &lt;explode_bomb&gt;</span><br><span class="line">    16f1:       48 8b 5b 08             mov    0x8(%rbx),%rbx</span><br><span class="line">    16f5:       83 ed 01                sub    $0x1,%ebp</span><br><span class="line">    16f8:       75 e8                   jne    16e2 &lt;phase_6+0xd4&gt;</span><br><span class="line">    16fa:       48 8b 44 24 58          mov    0x58(%rsp),%rax</span><br><span class="line">    16ff:       64 48 33 04 25 28 00    xor    %fs:0x28,%rax</span><br><span class="line">    1706:       00 00</span><br><span class="line">    1708:       74 05                   je     170f &lt;phase_6+0x101&gt;</span><br><span class="line">    170a:       e8 f1 f7 ff ff          callq  f00 &lt;__stack_chk_fail@plt&gt;</span><br><span class="line">    170f:       48 83 c4 68             add    $0x68,%rsp</span><br><span class="line">    1713:       5b                      pop    %rbx</span><br><span class="line">    1714:       5d                      pop    %rbp</span><br><span class="line">    1715:       41 5c                   pop    %r12</span><br><span class="line">    1717:       41 5d                   pop    %r13</span><br><span class="line">    1719:       c3                      retq</span><br><span class="line"></span><br></pre></td></tr></table></figure><h3 id="arm版本"><a class="anchor" href="#arm版本">#</a> arm 版本</h3><p>phase_1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0000000000401028 &lt;phase_1&gt;:</span><br><span class="line">  401028:       a9bf7bfd        stp     x29, x30, [sp, #-16]!</span><br><span class="line">  40102c:       910003fd        mov     x29, sp</span><br><span class="line">  401030:       b0000001        adrp    x1, 402000 &lt;submitr+0x440&gt;</span><br><span class="line">  401034:       9118c021        add     x1, x1, #0x630</span><br><span class="line">  401038:       94000148        bl      401558 &lt;strings_not_equal&gt;</span><br><span class="line">  40103c:       35000060        cbnz    w0, 401048 &lt;phase_1+0x20&gt;</span><br><span class="line">  401040:       a8c17bfd        ldp     x29, x30, [sp], #16    //还原栈帧</span><br><span class="line">  401044:       d65f03c0        ret  </span><br><span class="line">  401048:       94000205        bl      40185c &lt;explode_bomb&gt;</span><br><span class="line">  40104c:       17fffffd        b       401040 &lt;phase_1+0x18&gt;</span><br></pre></td></tr></table></figure><p>phase_2</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">0000000000401050 &lt;phase_2&gt;:</span><br><span class="line">  401050:       a9bc7bfd        stp     x29, x30, [sp, #-64]! </span><br><span class="line">  401054:       910003fd        mov     x29, sp       </span><br><span class="line">  401058:       a90153f3        stp     x19, x20, [sp, #16]   //从低到高依次是29 30 19 20</span><br><span class="line">  40105c:       9100a3a1        add     x1, x29, #0x28    //x1=x29+40byte</span><br><span class="line">  401060:       9400020e        bl      401898 &lt;read_six_numbers&gt;</span><br><span class="line">  401064:       b9402ba0        ldr     w0, [x29, #40]    //也就是x1那处的字节</span><br><span class="line">  401068:       35000080        cbnz    w0, 401078 &lt;phase_2+0x28&gt;    //w0！=0时跳转爆炸，也就是第一个数字为0</span><br><span class="line">  40106c:       b9402fa0        ldr     w0, [x29, #44]   //第二个数字</span><br><span class="line">  401070:       7100041f        cmp     w0, #0x1</span><br><span class="line">  401074:       54000040        b.eq    40107c &lt;phase_2+0x2c&gt;  //相等跳转否则顺序执行爆炸，则第二个数字也得是1</span><br><span class="line">  401078:       940001f9        bl      40185c &lt;explode_bomb&gt;</span><br><span class="line">  40107c:       9100a3b3        add     x19, x29, #0x28   //第一个数字的位置存放在x19中</span><br><span class="line">  401080:       91004274        add     x20, x19, #0x10   //x20中存放x19+16byte后的位置</span><br><span class="line">  401084:       14000004        b       401094 &lt;phase_2+0x44&gt;</span><br><span class="line">  401088:       91001273        add     x19, x19, #0x4  //跳转到这里19+4，到20的位置</span><br><span class="line">  40108c:       eb14027f        cmp     x19, x20  //再次比较19和20相等时可以结束循环，不相等重复操作，而循环次数是                                                     16/4=4次</span><br><span class="line">  401090:       54000120        b.eq    4010b4 &lt;phase_2+0x64&gt;  // b.none</span><br><span class="line">  401094:       b9400260        ldr     w0, [x19]   //x19中的值到w0中，也就是第一个数字</span><br><span class="line">  401098:       b9400661        ldr     w1, [x19, #4]  //第二个数字到w1</span><br><span class="line">  40109c:       0b010000        add     w0, w0, w1   //w0更新为原先加w1</span><br><span class="line">  4010a0:       b9400a61        ldr     w1, [x19, #8]  //第三个数字存放在w1中</span><br><span class="line">  4010a4:       6b00003f        cmp     w1, w0   //比较如果相等才可以跳转，否则顺序执行产生爆炸，所以第三个数字是1</span><br><span class="line">  4010a8:       54ffff00        b.eq    401088 &lt;phase_2+0x38&gt;  // b.none</span><br><span class="line">  4010ac:       940001ec        bl      40185c &lt;explode_bomb&gt;</span><br><span class="line">  4010b0:       17fffff6        b       401088 &lt;phase_2+0x38&gt;</span><br><span class="line">  4010b4:       a94153f3        ldp     x19, x20, [sp, #16]   //还原栈帧</span><br><span class="line">  4010b8:       a8c47bfd        ldp     x29, x30, [sp], #64</span><br><span class="line">  4010bc:       d65f03c0        ret</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>phase_3</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">00000000004010c0 &lt;phase_3&gt;:</span><br><span class="line">  4010c0:       a9be7bfd        stp     x29, x30, [sp, #-32]!  //32字节的空间</span><br><span class="line">  4010c4:       910003fd        mov     x29, sp</span><br><span class="line">  4010c8:       910063a3        add     x3, x29, #0x18  //x29+24byte到x3</span><br><span class="line">  4010cc:       910073a2        add     x2, x29, #0x1c  //x29+28字节到x2</span><br><span class="line">  4010d0:       b0000001        adrp    x1, 402000 &lt;submitr+0x440&gt;  </span><br><span class="line">  4010d4:       9119a021        add     x1, x1, #0x668   //x1=0x402668</span><br><span class="line">  4010d8:       97ffff26        bl      400d70 &lt;__isoc99_sscanf@plt&gt;  //调用sscanf</span><br><span class="line">  4010dc:       7100041f        cmp     w0, #0x1</span><br><span class="line">  4010e0:       5400026d        b.le    40112c &lt;phase_3+0x6c&gt;   //小于等于则爆炸，所以输入要求要大于1个数字</span><br><span class="line">  4010e4:       b9401fa0        ldr     w0, [x29, #28]  //x29+28机x2方中的数放到w0中</span><br><span class="line">  4010e8:       71000c1f        cmp     w0, #0x3  //比较w0和三，我们就先看等于三的情况</span><br><span class="line">  4010ec:       540003e0        b.eq    401168 &lt;phase_3+0xa8&gt;  // b.none</span><br><span class="line">  4010f0:       5400022d        b.le    401134 &lt;phase_3+0x74&gt;</span><br><span class="line">  4010f4:       528029e1        mov     w1, #0x14f                      // #335</span><br><span class="line">  4010f8:       7100141f        cmp     w0, #0x5</span><br><span class="line">  4010fc:       540002a0        b.eq    401150 &lt;phase_3+0x90&gt;  // b.none</span><br><span class="line">  401100:       528060e1        mov     w1, #0x307                      // #775</span><br><span class="line">  401104:       5400026b        b.lt    401150 &lt;phase_3+0x90&gt;  // b.tstop</span><br><span class="line">  401108:       52806601        mov     w1, #0x330                      // #816</span><br><span class="line">  40110c:       7100181f        cmp     w0, #0x6</span><br><span class="line">  401110:       54000200        b.eq    401150 &lt;phase_3+0x90&gt;  // b.none</span><br><span class="line">  401114:       52802661        mov     w1, #0x133                      // #307</span><br><span class="line">  401118:       71001c1f        cmp     w0, #0x7</span><br><span class="line">  40111c:       540001a0        b.eq    401150 &lt;phase_3+0x90&gt;  // b.none</span><br><span class="line">  401120:       940001cf        bl      40185c &lt;explode_bomb&gt;</span><br><span class="line">  401124:       52800001        mov     w1, #0x0                        // #0</span><br><span class="line">  401128:       1400000a        b       401150 &lt;phase_3+0x90&gt;</span><br><span class="line">  40112c:       940001cc        bl      40185c &lt;explode_bomb&gt;  </span><br><span class="line">  401130:       17ffffed        b       4010e4 &lt;phase_3+0x24&gt;</span><br><span class="line">  401134:       52807841        mov     w1, #0x3c2                      // #962</span><br><span class="line">  401138:       7100041f        cmp     w0, #0x1</span><br><span class="line">  40113c:       540000a0        b.eq    401150 &lt;phase_3+0x90&gt;  // b.none</span><br><span class="line">  401140:       52806721        mov     w1, #0x339                      // #825</span><br><span class="line">  401144:       5400006c        b.gt    401150 &lt;phase_3+0x90&gt;</span><br><span class="line">  401148:       52807b21        mov     w1, #0x3d9                      // #985</span><br><span class="line">  40114c:       35fffea0        cbnz    w0, 401120 &lt;phase_3+0x60&gt;</span><br><span class="line">  401150:       b9401ba0        ldr     w0, [x29, #24]  //x29+24即x3存储的位置的值放在w0中</span><br><span class="line">  401154:       6b01001f        cmp     w0, w1  //此时w0和w1必须想当否则就会爆炸，也就是说x3处存放的值需为172</span><br><span class="line">  401158:       54000040        b.eq    401160 &lt;phase_3+0xa0&gt;  // b.none</span><br><span class="line">  40115c:       940001c0        bl      40185c &lt;explode_bomb&gt;</span><br><span class="line">  401160:       a8c27bfd        ldp     x29, x30, [sp], #32</span><br><span class="line">  401164:       d65f03c0        ret</span><br><span class="line">  401168:       52801581        mov     w1, #0xac                       // w1=#172（w0==3）</span><br><span class="line">  40116c:       17fffff9        b       401150 &lt;phase_3+0x90&gt;</span><br></pre></td></tr></table></figure><p>phase_4</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">00000000004011c4 &lt;phase_4&gt;:</span><br><span class="line">  4011c4:       a9be7bfd        stp     x29, x30, [sp, #-32]!  //开辟空间32byte，从低到高放29 30</span><br><span class="line">  4011c8:       910003fd        mov     x29, sp    //x29保存当前地址</span><br><span class="line">  4011cc:       910063a3        add     x3, x29, #0x18  //x29+24byte位置放置x3</span><br><span class="line">  4011d0:       910073a2        add     x2, x29, #0x1c  //x3上面放x2</span><br><span class="line">  4011d4:       b0000001        adrp    x1, 402000 &lt;submitr+0x440&gt;   </span><br><span class="line">  4011d8:       9119a021        add     x1, x1, #0x668   </span><br><span class="line">  4011dc:       97fffee5        bl      400d70 &lt;__isoc99_sscanf@plt&gt; </span><br><span class="line">  4011e0:       7100081f        cmp     w0, #0x2   //说明必须输入两个值</span><br><span class="line">  4011e4:       54000081        b.ne    4011f4 &lt;phase_4+0x30&gt;  // b.any</span><br><span class="line">  4011e8:       b9401fa0        ldr     w0, [x29, #28]  //x2的位置中的数放到w0中</span><br><span class="line">  4011ec:       7100381f        cmp     w0, #0xe  //比较也就是说x2处必须是&lt;=14</span><br><span class="line">  4011f0:       54000049        b.ls    4011f8 &lt;phase_4+0x34&gt;  // b.plast  </span><br><span class="line">  4011f4:       9400019a        bl      40185c &lt;explode_bomb&gt;</span><br><span class="line">  4011f8:       528001c2        mov     w2, #0xe                         // #14</span><br><span class="line">  4011fc:       52800001        mov     w1, #0x0                        // #0</span><br><span class="line">  401200:       b9401fa0        ldr     w0, [x29, #28]  //x2中的数放到w0中然后，作为第一个参数，执行func4</span><br><span class="line">  401204:       97ffffdb        bl      401170 &lt;func4&gt;</span><br><span class="line">  401208:       7100141f        cmp     w0, #0x5     //说明函数返回值需要是5而</span><br><span class="line">  40120c:       54000081        b.ne    40121c &lt;phase_4+0x58&gt;  // b.any</span><br><span class="line">  401210:       b9401ba0        ldr     w0, [x29, #24]    //x3也需要是5</span><br><span class="line">  401214:       7100141f        cmp     w0, #0x5    </span><br><span class="line">  401218:       54000040        b.eq    401220 &lt;phase_4+0x5c&gt;  // b.none</span><br><span class="line">  40121c:       94000190        bl      40185c &lt;explode_bomb&gt;</span><br><span class="line">  401220:       a8c27bfd        ldp     x29, x30, [sp], #32</span><br><span class="line">  401224:       d65f03c0        ret</span><br><span class="line">0000000000401170 &lt;func4&gt;:  //一眼看出来递归调用依然是取一种最简单的情况	</span><br><span class="line">  401170:       a9bf7bfd        stp     x29, x30, [sp, #-16]!  </span><br><span class="line">  401174:       910003fd        mov     x29, sp </span><br><span class="line">  401178:       4b010043        sub     w3, w2, w1   //w3=w2-w1</span><br><span class="line">  40117c:       0b437c63        add     w3, w3, w3, lsr #31  //w3&gt;0不操作如果&lt;0+1操作</span><br><span class="line">  401180:       0b830423        add     w3, w1, w3, asr #1   //w3=（w3）/2+w1   //其实就是取中间的数</span><br><span class="line">  401184:       6b00007f        cmp     w3, w0  //比较w3和w0，w3-w0&gt;0,就跳转</span><br><span class="line">  401188:       540000cc        b.gt    4011a0 &lt;func4+0x30&gt;</span><br><span class="line">  40118c:       52800001        mov     w1, #0x0                        // #0</span><br><span class="line">  401190:       5400010b        b.lt    4011b0 &lt;func4+0x40&gt;  // b.tstop   //&lt;=的情况</span><br><span class="line">  401194:       2a0103e0        mov     w0, w1        //这部分讲就是将下界移动到w0中进行返回</span><br><span class="line">  401198:       a8c17bfd        ldp     x29, x30, [sp], #16</span><br><span class="line">  40119c:       d65f03c0        ret</span><br><span class="line">  4011a0:       51000462        sub     w2, w3, #0x1  //w2=w3-	1  也就是说这是个二分查找中间值比所找的值大，所                                                         以右边界减小到原来中间值-1</span><br><span class="line">  4011a4:       97fffff3        bl      401170 &lt;func4&gt; </span><br><span class="line">  4011a8:       531f7801        lsl     w1, w0, #1   //只进行*2操作</span><br><span class="line">  4011ac:       17fffffa        b       401194 &lt;func4+0x24&gt;   //  b只进行跳转程序，不会返回原来程序</span><br><span class="line">  4011b0:       11000461        add     w1, w3, #0x1   //左边界到原来的中间值+1</span><br><span class="line">  4011b4:       97ffffef        bl      401170 &lt;func4&gt;</span><br><span class="line">  4011b8:       531f7800        lsl     w0, w0, #1</span><br><span class="line">  4011bc:       11000401        add     w1, w0, #0x1  //对查找的结果进行*2+1</span><br><span class="line">  4011c0:       17fffff5        b       401194 &lt;func4+0x24&gt;</span><br></pre></td></tr></table></figure><p>phase_5</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">0000000000401228 &lt;phase_5&gt;:</span><br><span class="line">  401228:       a9bd7bfd        stp     x29, x30, [sp, #-48]!  //开辟48byte</span><br><span class="line">  40122c:       910003fd        mov     x29, sp   //存入29 </span><br><span class="line">  401230:       f9000bf3        str     x19, [sp, #16]   //x19中内容存入sp+16字节位置</span><br><span class="line">  401234:       aa0003f3        mov     x19, x0   //将x0中内容存放到x19中</span><br><span class="line">  401238:       940000bd        bl      40152c &lt;string_length&gt;    </span><br><span class="line">  40123c:       7100181f        cmp     w0, #0x6  //说明要输入6个字符</span><br><span class="line">  401240:       540002a1        b.ne    401294 &lt;phase_5+0x6c&gt;  // b.any    </span><br><span class="line">  401244:       d2800000        mov     x0, #0x0                  // #0</span><br><span class="line">  401248:       9100a3a3        add     x3, x29, #0x28     //x29+40byte的地址存入x3</span><br><span class="line">  40124c:       b0000002        adrp    x2, 402000 &lt;submitr+0x440&gt;</span><br><span class="line">  401250:       91188042        add     x2, x2, #0x620  //x2=402620</span><br><span class="line">  401254:       38606a61        ldrb    w1, [x19, x0]  //存放的第一个字符赋值给w1</span><br><span class="line">  401258:       12000c21        and     w1, w1, #0xf   //取w1低四位 </span><br><span class="line">  40125c:       3861c841        ldrb    w1, [x2, w1, sxtw]  //x2+w1地址处的字符再赋值给w1</span><br><span class="line">  401260:       38236801        strb    w1, [x0, x3]  //w1再存放到x3所指地址的第一个位置</span><br><span class="line">  401264:       91000400        add     x0, x0, #0x1  //x0+1</span><br><span class="line">  401268:       f100181f        cmp     x0, #0x6  //说明循环6次</span><br><span class="line">  40126c:       54ffff41        b.ne    401254 &lt;phase_5+0x2c&gt;  // b.any</span><br><span class="line">  401270:       3900bbbf        strb    wzr, [x29, #46]   //给写入后的字符串加上&quot;\0&quot;</span><br><span class="line">  401274:       b0000001        adrp    x1, 402000 &lt;submitr+0x440&gt;</span><br><span class="line">  401278:       9119c021        add     x1, x1, #0x670   //x1=402670</span><br><span class="line">  40127c:       9100a3a0        add     x0, x29, #0x28   //x0写入刚才计算得到的字符串</span><br><span class="line">  401280:       940000b6        bl      401558 &lt;strings_not_equal&gt;    //必须相等否则跳转爆炸 </span><br><span class="line">  401284:       350000c0        cbnz    w0, 40129c &lt;phase_5+0x74&gt;</span><br><span class="line">  401288:       f9400bf3        ldr     x19, [sp, #16]</span><br><span class="line">  40128c:       a8c37bfd        ldp     x29, x30, [sp], #48</span><br><span class="line">  401290:       d65f03c0        ret</span><br><span class="line">  401294:       94000172        bl      40185c &lt;explode_bomb&gt;</span><br><span class="line">  401298:       17ffffeb        b       401244 &lt;phase_5+0x1c&gt;</span><br><span class="line">  40129c:       94000170        bl      40185c &lt;explode_bomb&gt;</span><br><span class="line">  4012a0:       17fffffa        b       401288 &lt;phase_5+0x60&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>phase_6</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">00000000004012a4 &lt;phase_6&gt;:</span><br><span class="line">4012a4:       a9b87bfd        stp     x29, x30, [sp, #-128]!</span><br><span class="line">4012a8:       910003fd        mov     x29, sp</span><br><span class="line">4012ac:       a90153f3        stp     x19, x20, [sp, #16]</span><br><span class="line">4012b0:       f90013f5        str     x21, [sp, #32]</span><br><span class="line">4012b4:       9101a3a1        add     x1, x29, #0x68</span><br><span class="line">4012b8:       94000178        bl      401898 &lt;read_six_numbers&gt;     //说明读取了六个数字</span><br><span class="line">4012bc:       d2800015        mov     x21, #0x0                       // #0</span><br><span class="line">4012c0:       9101a3b4        add     x20, x29, #0x68  //x29+104byte的地址存放在x20中</span><br><span class="line">4012c4:       1400000d        b       4012f8 &lt;phase_6+0x54&gt;</span><br><span class="line">4012c8:       94000165        bl      40185c &lt;explode_bomb&gt;</span><br><span class="line">4012cc:       1400000f        b       401308 &lt;phase_6+0x64&gt;</span><br><span class="line">4012d0:       11000673        add     w19, w19, #0x1</span><br><span class="line">4012d4:       7100167f        cmp     w19, #0x5</span><br><span class="line">4012d8:       540000ec        b.gt    4012f4 &lt;phase_6+0x50&gt;</span><br><span class="line">4012dc:       b8757a81        ldr     w1, [x20, x21, lsl #2]</span><br><span class="line">4012e0:       b873da80        ldr     w0, [x20, w19, sxtw #2]</span><br><span class="line">4012e4:       6b00003f        cmp     w1, w0</span><br><span class="line">4012e8:       54ffff41        b.ne    4012d0 &lt;phase_6+0x2c&gt;  // b.any</span><br><span class="line">4012ec:       9400015c        bl      40185c &lt;explode_bomb&gt;</span><br><span class="line">4012f0:       17fffff8        b       4012d0 &lt;phase_6+0x2c&gt;</span><br><span class="line">4012f4:       910006b5        add     x21, x21, #0x1</span><br><span class="line">4012f8:       b8757a80        ldr     w0, [x20, x21, lsl #2]</span><br><span class="line">4012fc:       51000400        sub     w0, w0, #0x1</span><br><span class="line">401300:       7100141f        cmp     w0, #0x5</span><br><span class="line">401304:       54fffe28        b.hi    4012c8 &lt;phase_6+0x24&gt;  // b.pmore</span><br><span class="line">401308:       110006b3        add     w19, w21, #0x1</span><br><span class="line">40130c:       f10016bf        cmp     x21, #0x5</span><br><span class="line">401310:       54fffe61        b.ne    4012dc &lt;phase_6+0x38&gt;  // b.any</span><br><span class="line">401314:       d2800000        mov     x0, #0x0                        // #0</span><br><span class="line">401318:       9101a3a2        add     x2, x29, #0x68</span><br><span class="line">40131c:       528000e3        mov     w3, #0x7                        // #7</span><br><span class="line">401320:       b8607841        ldr     w1, [x2, x0, lsl #2]</span><br><span class="line">401324:       4b010061        sub     w1, w3, w1</span><br><span class="line">401328:       b8207841        str     w1, [x2, x0, lsl #2]</span><br><span class="line">40132c:       91000400        add     x0, x0, #0x1</span><br><span class="line">401330:       f100181f        cmp     x0, #0x6</span><br><span class="line">401334:       54ffff61        b.ne    401320 &lt;phase_6+0x7c&gt;  // b.any</span><br><span class="line">401338:       d2800003        mov     x3, #0x0                        // #0</span><br><span class="line">40133c:       9101a3a6        add     x6, x29, #0x68</span><br><span class="line">401340:       f00000e4        adrp    x4, 420000 &lt;strlen@GLIBC_2.17&gt;</span><br><span class="line">401344:       9100e3a5        add     x5, x29, #0x38</span><br><span class="line">401348:       14000009        b       40136c &lt;phase_6+0xc8&gt;</span><br><span class="line">40134c:       f9400421        ldr     x1, [x1, #8]</span><br><span class="line">401350:       11000400        add     w0, w0, #0x1</span><br><span class="line">401354:       6b02001f        cmp     w0, w2</span><br><span class="line">401358:       54ffffa1        b.ne    40134c &lt;phase_6+0xa8&gt;  // b.any</span><br><span class="line">40135c:       f82378a1        str     x1, [x5, x3, lsl #3]</span><br><span class="line">401360:       91000463        add     x3, x3, #0x1</span><br><span class="line">401364:       f100187f        cmp     x3, #0x6</span><br><span class="line">401368:       540000e0        b.eq    401384 &lt;phase_6+0xe0&gt;  // b.none</span><br><span class="line">40136c:       b86378c2        ldr     w2, [x6, x3, lsl #2]</span><br><span class="line">401370:       52800020        mov     w0, #0x1                        // #1</span><br><span class="line">401374:       91044081        add     x1, x4, #0x110</span><br><span class="line">401378:       6b00005f        cmp     w2, w0</span><br><span class="line">40137c:       54fffe8c        b.gt    40134c &lt;phase_6+0xa8&gt;</span><br><span class="line">401380:       17fffff7        b       40135c &lt;phase_6+0xb8&gt;</span><br><span class="line">401384:       f9401fb3        ldr     x19, [x29, #56]</span><br><span class="line">401388:       f94023a0        ldr     x0, [x29, #64]</span><br><span class="line">40138c:       f9000660        str     x0, [x19, #8]</span><br><span class="line">401390:       f94027a1        ldr     x1, [x29, #72]</span><br><span class="line">401394:       f9000401        str     x1, [x0, #8]</span><br><span class="line">401398:       f9402ba0        ldr     x0, [x29, #80]</span><br><span class="line">40139c:       f9000420        str     x0, [x1, #8]</span><br><span class="line">4013a0:       f9402fa1        ldr     x1, [x29, #88]</span><br><span class="line">4013a4:       f9000401        str     x1, [x0, #8]</span><br><span class="line">4013a8:       f94033a0        ldr     x0, [x29, #96]</span><br><span class="line">4013ac:       f9000420        str     x0, [x1, #8]</span><br><span class="line">4013b0:       f900041f        str     xzr, [x0, #8]</span><br><span class="line">4013b4:       528000b4        mov     w20, #0x5                       // #5</span><br><span class="line">4013b8:       14000004        b       4013c8 &lt;phase_6+0x124&gt;</span><br><span class="line">4013bc:       f9400673        ldr     x19, [x19, #8]</span><br><span class="line">4013c0:       71000694        subs    w20, w20, #0x1</span><br><span class="line">4013c4:       54000100        b.eq    4013e4 &lt;phase_6+0x140&gt;  // b.none</span><br><span class="line">4013c8:       f9400660        ldr     x0, [x19, #8]</span><br><span class="line">4013cc:       b9400261        ldr     w1, [x19]</span><br><span class="line">4013d0:       b9400000        ldr     w0, [x0]</span><br><span class="line">4013d4:       6b00003f        cmp     w1, w0</span><br><span class="line">4013d8:       54ffff2a        b.ge    4013bc &lt;phase_6+0x118&gt;  // b.tcont</span><br><span class="line">4013dc:       94000120        bl      40185c &lt;explode_bomb&gt;</span><br><span class="line">4013e0:       17fffff7        b       4013bc &lt;phase_6+0x118&gt;</span><br><span class="line">4013e4:       a94153f3        ldp     x19, x20, [sp, #16]</span><br><span class="line">4013e8:       f94013f5        ldr     x21, [sp, #32]</span><br><span class="line">4013ec:       a8c87bfd        ldp     x29, x30, [sp], #128</span><br><span class="line">4013f0:       d65f03c0        ret</span><br></pre></td></tr></table></figure><h3 id="buffer"><a class="anchor" href="#buffer">#</a> buffer</h3><p>重定位（Relocation）</p><p>目标：不注入新代码，只覆盖 <code>getbuf()</code> 的返回地址，让它跳到现有函数 <code>touch1()</code> 。</p><p>关键：</p><p>用 <code>objdump -d ctarget</code> 找出 <code>touch1</code> 的入口地址。</p><p>计算小端字节序，并在溢出 “刚好到返回地址” 的位置写入这 8 字节地址。</p><p>运行 <code>./hex2raw</code> 生成原始字节串，再喂给 <code>./ctarget</code> ，观察 “Touch1!” 输出来验证。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">00000000004018a9 &lt;getbuf&gt;:</span><br><span class="line">  4018a9:       48 83 ec 28             sub    $0x28,%rsp   //分配了40byte的空间</span><br><span class="line">  4018ad:       48 89 e7                mov    %rsp,%rdi</span><br><span class="line">  4018b0:       e8 ac 02 00 00          callq  401b61 &lt;Gets&gt;  //调用Get函数</span><br><span class="line">  4018b5:       b8 01 00 00 00          mov    $0x1,%eax</span><br><span class="line">  4018ba:       48 83 c4 28             add    $0x28,%rsp</span><br><span class="line">  4018be:       c3                      retq</span><br><span class="line"></span><br><span class="line">00000000004018bf &lt;touch1&gt;:   //得到了touch1 的地址</span><br><span class="line">  4018bf:       48 83 ec 08             sub    $0x8,%rsp</span><br><span class="line">  4018c3:       48 c1 ec 04             shr    $0x4,%rsp</span><br><span class="line">  4018c7:       48 c1 e4 04             shl    $0x4,%rsp</span><br><span class="line">  4018cb:       c7 05 27 2c 20 00 01    movl   $0x1,0x202c27(%rip)        # 6044fc &lt;vlevel&gt;</span><br><span class="line">  4018d2:       00 00 00</span><br><span class="line">  4018d5:       48 8d 3d 48 19 00 00    lea    0x1948(%rip),%rdi        # 403224 &lt;_IO_stdin_used+0x314&gt;</span><br><span class="line">  4018dc:       e8 df f3 ff ff          callq  400cc0 &lt;puts@plt&gt;</span><br><span class="line">  4018e1:       bf 01 00 00 00          mov    $0x1,%edi</span><br><span class="line">  4018e6:       e8 d8 04 00 00          callq  401dc3 &lt;validate&gt;</span><br><span class="line">  4018eb:       bf 00 00 00 00          mov    $0x0,%edi</span><br><span class="line">  4018f0:       e8 3b f5 ff ff          callq  400e30 &lt;exit@plt&gt;</span><br></pre></td></tr></table></figure><p><strong>指定参数</strong></p><p>第二阶段涉及将少量代码作为漏洞利用字符串的一部分注入。</p><p>在文件 <code>ctarget</code> 中，有一个名为 <code>touch2</code> 的函数的代码</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span> <span class="type">void</span> <span class="title function_">touch2</span><span class="params">(<span class="type">unsigned</span> val)</span>  <span class="comment">//注意参数</span></span><br><span class="line">2 &#123;</span><br><span class="line"><span class="number">3</span>     vlevel = <span class="number">2</span>; <span class="comment">/* Part of validation protocol */</span></span><br><span class="line"><span class="number">4</span>     <span class="keyword">if</span> (val == cookie) &#123;</span><br><span class="line"><span class="number">5</span>         <span class="built_in">printf</span>(<span class="string">&quot;Touch2!: You called touch2(0x%.8x)\n&quot;</span>, val);</span><br><span class="line"><span class="number">6</span>         validate(<span class="number">2</span>);</span><br><span class="line"><span class="number">7</span>     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">8</span>         <span class="built_in">printf</span>(<span class="string">&quot;Misfire: You called touch2(0x%.8x)\n&quot;</span>, val);</span><br><span class="line"><span class="number">9</span>         fail(<span class="number">2</span>);</span><br><span class="line"><span class="number">10</span>     &#125;</span><br><span class="line"><span class="number">11</span>     <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">12</span> &#125;</span><br></pre></td></tr></table></figure><p>cookie：0x43227a88</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">00000000004018f5 &lt;touch2&gt;:</span><br><span class="line">  4018f5:       48 83 ec 08             sub    $0x8,%rsp</span><br><span class="line">  4018f9:       89 fa                   mov    %edi,%edx</span><br><span class="line">  4018fb:       48 c1 ec 04             shr    $0x4,%rsp</span><br><span class="line">  4018ff:       48 c1 e4 04             shl    $0x4,%rsp</span><br><span class="line">  401903:       c7 05 ef 3b 20 00 02    movl   $0x2,0x203bef(%rip)        # 6054fc &lt;vlevel&gt;</span><br><span class="line">  40190a:       00 00 00</span><br><span class="line">  40190d:       39 3d f1 3b 20 00       cmp    %edi,0x203bf1(%rip)        # 605504 &lt;cookie&gt;</span><br><span class="line">  401913:       75 22                   jne    401937 &lt;touch2+0x42&gt;</span><br><span class="line">  401915:       48 8d 35 5c 1a 00 00    lea    0x1a5c(%rip),%rsi        # 403378 &lt;_IO_stdin_used+0x338&gt;</span><br><span class="line">  40191c:       bf 01 00 00 00          mov    $0x1,%edi</span><br><span class="line">  401921:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  401926:       e8 b5 f4 ff ff          callq  400de0 &lt;__printf_chk@plt&gt;</span><br><span class="line">  40192b:       bf 02 00 00 00          mov    $0x2,%edi</span><br><span class="line">  401930:       e8 af 05 00 00          callq  401ee4 &lt;validate&gt;</span><br><span class="line">  401935:       eb 20                   jmp    401957 &lt;touch2+0x62&gt;</span><br><span class="line">  401937:       48 8d 35 62 1a 00 00    lea    0x1a62(%rip),%rsi        # 4033a0 &lt;_IO_stdin_used+0x360&gt;</span><br><span class="line">  40193e:       bf 01 00 00 00          mov    $0x1,%edi</span><br><span class="line">  401943:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  401948:       e8 93 f4 ff ff          callq  400de0 &lt;__printf_chk@plt&gt;</span><br><span class="line">  40194d:       bf 02 00 00 00          mov    $0x2,%edi</span><br><span class="line">  401952:       e8 5a 06 00 00          callq  401fb1 &lt;fail&gt;</span><br><span class="line">  401957:       bf 00 00 00 00          mov    $0x0,%edi</span><br><span class="line">  40195c:       e8 cf f4 ff ff          callq  400e30 &lt;exit@plt&gt;</span><br></pre></td></tr></table></figure><p><strong>Level 3</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0000000000401a8e &lt;test&gt;:</span><br><span class="line">  401a8e:       48 83 ec 08             sub    $0x8,%rsp</span><br><span class="line">  401a92:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  401a97:       e8 0d fe ff ff          callq  4018a9 &lt;getbuf&gt;</span><br><span class="line">  401a9c:       89 c2                   mov    %eax,%edx</span><br><span class="line">  401a9e:       48 8d 35 43 18 00 00    lea    0x1843(%rip),%rsi        # 4032e8 &lt;_IO_stdin_used+0x3d8&gt;</span><br><span class="line">  401aa5:       bf 01 00 00 00          mov    $0x1,%edi</span><br><span class="line">  401aaa:       b8 00 00 00 00          mov    $0x0,%eax</span><br><span class="line">  401aaf:       e8 2c f3 ff ff          callq  400de0 &lt;__printf_chk@plt&gt;</span><br><span class="line">  401ab4:       48 83 c4 08             add    $0x8,%rsp</span><br><span class="line">  401ab8:       c3                      retq</span><br><span class="line"></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">11</span> <span class="type">void</span> <span class="title function_">touch3</span><span class="params">(<span class="type">char</span> *sval)</span>  <span class="comment">//注意参数</span></span><br><span class="line">12 &#123;</span><br><span class="line"><span class="number">13</span>     vlevel = <span class="number">3</span>; <span class="comment">/* Part of validation protocol */</span></span><br><span class="line"><span class="number">14</span>     <span class="keyword">if</span> (hexmatch(cookie, sval)) &#123;</span><br><span class="line"><span class="number">15</span>         <span class="built_in">printf</span>(<span class="string">&quot;Touch3!: You called touch3(\&quot;%s\&quot;)\n&quot;</span>, sval);</span><br><span class="line"><span class="number">16</span>         validate(<span class="number">3</span>);</span><br><span class="line"><span class="number">17</span>     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="number">18</span>         <span class="built_in">printf</span>(<span class="string">&quot;Misfire: You called touch3(\&quot;%s\&quot;)\n&quot;</span>, sval);</span><br><span class="line"><span class="number">19</span>         fail(<span class="number">3</span>);</span><br><span class="line"><span class="number">20</span>     &#125;</span><br><span class="line"><span class="number">21</span>     <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line"><span class="number">22</span> &#125;</span><br></pre></td></tr></table></figure><p>0000000000401a14<touch3></touch3></p><p><strong>level4</strong></p><p>ROP 攻击</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br></pre></td><td class="code"><pre><span class="line">0000000000401abf &lt;addval_424&gt;:</span><br><span class="line">  401abf:       8d 87 a7 50 90 c3       lea    -0x3c6faf59(%rdi),%eax</span><br><span class="line">  401ac5:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401ac6 &lt;getval_130&gt;:</span><br><span class="line">  401ac6:       b8 d8 c3 76 0f          mov    $0xf76c3d8,%eax</span><br><span class="line">  401acb:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401acc &lt;addval_232&gt;:</span><br><span class="line">  401acc:       8d 87 48 89 c7 90       lea    -0x6f3876b8(%rdi),%eax     //mov rax rdi</span><br><span class="line">  401ad2:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401ad3 &lt;getval_104&gt;:</span><br><span class="line">  401ad3:       b8 48 89 c7 c3          mov    $0xc3c78948,%eax    //48 89 c7 rax值存入rdi中</span><br><span class="line">  401ad8:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401ad9 &lt;addval_489&gt;:</span><br><span class="line">  401ad9:       8d 87 db 48 81 c7       lea    -0x387eb725(%rdi),%eax</span><br><span class="line">  401adf:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401ae0 &lt;setval_484&gt;:</span><br><span class="line">  401ae0:       c7 07 58 90 90 c3       movl   $0xc3909058,(%rdi)      //58出现说明时返回rax的值</span><br><span class="line">  401ae6:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401ae7 &lt;addval_375&gt;:</span><br><span class="line">  401ae7:       8d 87 58 90 90 c3       lea    -0x3c6f6fa8(%rdi),%eax  </span><br><span class="line">  401aed:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401aee &lt;addval_499&gt;:</span><br><span class="line">  401aee:       8d 87 4a 89 c7 c3       lea    -0x3c3876b6(%rdi),%eax</span><br><span class="line">  401af4:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401af5 &lt;mid_farm&gt;:</span><br><span class="line">  401af5:       b8 01 00 00 00          mov    $0x1,%eax</span><br><span class="line">  401afa:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401afb &lt;add_xy&gt;:</span><br><span class="line">  401afb:       48 8d 04 37             lea    (%rdi,%rsi,1),%rax   //计算偏移量的函数</span><br><span class="line">  401aff:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b00 &lt;getval_265&gt;:</span><br><span class="line">  401b00:       b8 5d 89 d6 90          mov    $0x90d6895d,%eax  //edx-&gt;esi</span><br><span class="line">  401b05:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b06 &lt;getval_350&gt;:</span><br><span class="line">  401b06:       b8 89 c1 c4 d2          mov    $0xd2c4c189,%eax  //eax-&gt;ecx</span><br><span class="line">  401b0b:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b0c &lt;setval_200&gt;:</span><br><span class="line">  401b0c:       c7 07 48 89 e0 c1       movl   $0xc1e08948,(%rdi)   //rsp-&gt;rax</span><br><span class="line">  401b12:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b13 &lt;setval_339&gt;:</span><br><span class="line">  401b13:       c7 07 89 ca 18 c9       movl   $0xc918ca89,(%rdi)  //ecx-&gt;edx</span><br><span class="line">  401b19:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b1a &lt;setval_390&gt;:</span><br><span class="line">  401b1a:       c7 07 81 d6 08 db       movl   $0xdb08d681,(%rdi)</span><br><span class="line">  401b20:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b21 &lt;getval_108&gt;:</span><br><span class="line">  401b21:       b8 48 89 e0 c2          mov    $0xc2e08948,%eax</span><br><span class="line">  401b26:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b27 &lt;getval_332&gt;:</span><br><span class="line">  401b27:       b8 48 89 e0 c3          mov    $0xc3e08948,%eax</span><br><span class="line">  401b2c:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b2d &lt;addval_235&gt;:</span><br><span class="line">  401b2d:       8d 87 ca e3 89 c1       lea    -0x3e761c36(%rdi),%eax   //eax-&gt;ecx   401b31</span><br><span class="line">  401b33:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b34 &lt;addval_154&gt;:</span><br><span class="line">  401b34:       8d 87 89 d6 18 c0       lea    -0x3fe72977(%rdi),%eax</span><br><span class="line">  401b3a:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b3b &lt;addval_374&gt;:</span><br><span class="line">  401b3b:       8d 87 8b d6 08 c0       lea    -0x3ff72975(%rdi),%eax</span><br><span class="line">  401b41:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b42 &lt;getval_465&gt;:</span><br><span class="line">  401b42:       b8 89 c1 18 d2          mov    $0xd218c189,%eax</span><br><span class="line">  401b47:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b48 &lt;setval_300&gt;:</span><br><span class="line">  401b48:       c7 07 89 c1 c2 de       movl   $0xdec2c189,(%rdi)</span><br><span class="line">  401b4e:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b4f &lt;addval_389&gt;:</span><br><span class="line">  401b4f:       8d 87 8d d6 84 d2       lea    -0x2d7b2973(%rdi),%eax</span><br><span class="line">  401b55:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b56 &lt;addval_352&gt;:</span><br><span class="line">  401b56:       8d 87 89 ca c3 73       lea    0x73c3ca89(%rdi),%eax  //ecx ——》edx  401b58</span><br><span class="line">  401b5c:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b5d &lt;setval_233&gt;:</span><br><span class="line">  401b5d:       c7 07 48 89 e0 c7       movl   $0xc7e08948,(%rdi)</span><br><span class="line">  401b63:       c3                      retq</span><br><span class="line">0000000000401b64 &lt;setval_471&gt;:</span><br><span class="line">  401b64:       c7 07 09 ca 08 d2       movl   $0xd208ca09,(%rdi)</span><br><span class="line">  401b6a:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b6b &lt;addval_393&gt;:</span><br><span class="line">  401b6b:       8d 87 89 d6 78 c9       lea    -0x36872977(%rdi),%eax</span><br><span class="line">  401b71:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b72 &lt;setval_417&gt;:</span><br><span class="line">  401b72:       c7 07 48 89 e0 c7       movl   $0xc7e08948,(%rdi)</span><br><span class="line">  401b78:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b79 &lt;getval_451&gt;:</span><br><span class="line">  401b79:       b8 89 ca 90 c3          mov    $0xc390ca89,%eax</span><br><span class="line">  401b7e:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b7f &lt;setval_480&gt;:</span><br><span class="line">  401b7f:       c7 07 89 c1 30 db       movl   $0xdb30c189,(%rdi)</span><br><span class="line">  401b85:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b86 &lt;addval_242&gt;:</span><br><span class="line">  401b86:       8d 87 89 ca 28 d2       lea    -0x2dd73577(%rdi),%eax</span><br><span class="line">  401b8c:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b8d &lt;getval_475&gt;:</span><br><span class="line">  401b8d:       b8 99 ca 08 d2          mov    $0xd208ca99,%eax</span><br><span class="line">  401b92:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b93 &lt;getval_435&gt;:</span><br><span class="line">  401b93:       b8 09 ca 38 c9          mov    $0xc938ca09,%eax</span><br><span class="line">  401b98:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401b99 &lt;setval_256&gt;:</span><br><span class="line">  401b99:       c7 07 12 4c 89 e0       movl   $0xe0894c12,(%rdi)</span><br><span class="line">  401b9f:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401ba0 &lt;setval_481&gt;:</span><br><span class="line">  401ba0:       c7 07 f8 89 ca 91       movl   $0x91ca89f8,(%rdi)</span><br><span class="line">  401ba6:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401ba7 &lt;getval_228&gt;:</span><br><span class="line">  401ba7:       b8 88 48 99 e0          mov    $0xe0994888,%eax</span><br><span class="line">  401bac:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401bad &lt;addval_149&gt;:</span><br><span class="line">  401bad:       8d 87 89 c1 48 d2       lea    -0x2db73e77(%rdi),%eax</span><br><span class="line">  401bb3:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401bb4 &lt;addval_397&gt;:</span><br><span class="line">  401bb4:       8d 87 11 81 c1 c3       lea    -0x3c3e7eef(%rdi),%eax</span><br><span class="line">  401bba:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401bbb &lt;setval_421&gt;:</span><br><span class="line">  401bbb:       c7 07 55 e0 a9 d6       movl   $0xd6a9e055,(%rdi)</span><br><span class="line">  401bc1:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401bc2 &lt;getval_196&gt;:</span><br><span class="line">  401bc2:       b8 89 d6 84 c9          mov    $0xc984d689,%eax</span><br><span class="line">  401bc7:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401bc8 &lt;getval_174&gt;:</span><br><span class="line">  401bc8:       b8 14 89 c1 c3          mov    $0xc3c18914,%eax    //401bca eax-》ecx</span><br><span class="line">  401bcd:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401bce &lt;getval_262&gt;:</span><br><span class="line">  401bce:       b8 48 89 e0 c3          mov    $0xc3e08948,%eax    //mov rsp rax  </span><br><span class="line">  401bd3:       c3                      retq</span><br><span class="line"></span><br><span class="line">0000000000401bd4 &lt;end_farm&gt;:</span><br><span class="line">  401bd4:       b8 01 00 00 00          mov    $0x1,%eax</span><br><span class="line">  401bd9:       c3                      retq</span><br><span class="line"></span><br></pre></td></tr></table></figure><h2 id="序章"><a class="anchor" href="#序章">#</a> 序章</h2><p>1.cpu 内部结构：PC（program count）<mark>大小为一个字的存储空间存储一个将要执行语句的地址，然后不断更新到下一条要执行的指令</mark></p><p>2. 寄存器文件：临时存放数据的空间</p><p>理解虚拟内存</p><p><img data-src="/images/csapp/screenshot-2025-04-05-201413.png" alt="屏幕截图 2025-04-05 201413"></p><p><mark>linux 核心：一切皆为文件</mark></p><p><img data-src="/images/csapp/screenshot-2025-04-05-202431.png" alt="屏幕截图 2025-04-05 202431"></p><h2 id="信息的表示与处理"><a class="anchor" href="#信息的表示与处理">#</a> 信息的表示与处理</h2><h3 id="信息的存储"><a class="anchor" href="#信息的存储">#</a> 信息的存储：</h3><p>1. 内存看作一个非常的数组，每个数字都有一个地址我把它们的集合称为<mark>虚拟地址空间</mark></p><p>2. 字长：决定虚拟空间的最大值</p><p>3.<mark> 大端法</mark>：最高有效字节放在低地址处，对应的就是小端法</p><p><img data-src="/images/csapp/screenshot-2025-04-05-203325.png" alt="屏幕截图 2025-04-05 203325"></p><p>移位运算</p><p><img data-src="/images/csapp/screenshot-2025-04-07-095851.png" alt="屏幕截图 2025-04-07 095851"></p><p>左移和逻辑右移一样，但是要注意算术右移移动完之后如果是负数是补 1，<mark>有符号数进行算术右移，无符号为逻辑右移</mark>，总之就是补它的符号位即可。</p><h3 id="整数的表示"><a class="anchor" href="#整数的表示">#</a> 整数的表示</h3><p>**<mark> 原码，反码，补码</mark></p><p>正数的三者完全一致，而负数的原码为符号位为 1 其他位按照正数计算即可如 - 1 用一个字节表示的话即 1000 0001</p><p>而负数的反码为符号位不变其他位取反，而补码是在反码的基础上再 + 1</p><p>-1 的补码就是 1111 1111 而从补码再转换到原码，就是除去符号位之后减 1 然后再取反</p><p>**<mark> 补码的直观理解</mark></p><p>首先我们的内存存储有符号数可以看作一个我们日常生活中的圆盘，比如 8 点到十点可以顺时针旋转两格也可以，逆时针旋转 10 就是 8-10 的效果等同于 8+2，这样我们把一个减法转换为加法，而 2 是通过公式 <mark>2 = 模 —10</mark> 来得到的，同理我们理解补码的计算规则，先求出反码来然后 + 1 得到补码</p><p><img data-src="/images/csapp/screenshot-2025-04-07-103211.png" alt="屏幕截图 2025-04-07 103211"></p><p>例子：101-010 即 5-2 则它等同于 5+（<span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>3</mn></msup></mrow><annotation encoding="application/x-tex">2^3</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:.8141079999999999em;vertical-align:0"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:.8141079999999999em"><span style="top:-3.063em;margin-right:.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span></span> -2） 模为 8</p><p>010 的反码就是各个位取反为 101，而<mark>任意数字加上他的反码都为每一位都是 1</mark>，010+101=111，而这时候加上 1 就变成了模，（这也就是为什么我们要求取完反码加 1），所以模 - 2 即可写成（010+101+1）-010=101+1 就是反码加 1</p><p>**<mark> 有无符号之间数字的转变</mark></p><p>原则：位模式不变，但是解释这些位的方式改变了</p><p>首先看无符号和有符号的映射关系（<mark>这里都对应的是补码，而不是原码</mark>，x 向量是补码然后这个函数目的是求它的真值）</p><p><img data-src="/images/csapp/screenshot-2025-04-07-104933.png" alt="屏幕截图 2025-04-07 104933"></p><p>w 表示位数，上面是无符号数，下面为有符号数，x（w-1）位表示的就是最高位</p><p><img data-src="/images/csapp/screenshot-2025-04-08-202033.png" alt="屏幕截图 2025-04-08 202033"></p><p>从上面的式子做差我们可以得到：</p><p>1. 不论有无符号当最高位为 0，则两者一致</p><p>2. 若最高位为 1，无符号转为有符号方法就是在原来基础上 ==-2 的 w 次 ==，w 为位数</p><p>反之，有符号转无符号就是 ==+2 的 w 次方 ==</p><p>**<mark> 注意</mark>：<br>c 语言中，有符号数和无符号数进行比较时，会把有符号数转换为无符号数</p><p>**<mark> 较小数据类型转换为较大数据类型</mark></p><p>当为无符号数时补零即可在前面，当为有符号数且最高位为 1，则在前面补 1，（好理解的方法就是，补一之后求原码可以保持一致，那么数据就一致）</p><p>**<mark> 较大类型转换较小数据类型</mark></p><p>先看无符号数：int -&gt;short 高 16 位数字被丢弃，相当于对原来的数字 mod 2 的 16 次</p><p>有符号数：</p><p><img data-src="/images/csapp/screenshot-2025-04-08-205056.png" alt="屏幕截图 2025-04-08 205056"></p><p>先转无符号再截断再转有符号</p><h3 id="整数的运算"><a class="anchor" href="#整数的运算">#</a> 整数的运算</h3><p><mark>一个原则：同号相加会产生溢出</mark></p><p>**<mark> 无符号数的加法</mark></p><p><img data-src="/images/csapp/screenshot-2025-04-09-095532.png" alt="屏幕截图 2025-04-09 095532"></p><p>判断是否溢出的程序，右边是对逻辑的简单证明</p><p>**<mark> 有符号数的加法</mark></p><p><img data-src="/images/csapp/screenshot-2025-04-09-101341.png" alt="屏幕截图 2025-04-09 101341"></p><p>**<mark> 无符号数的减法</mark></p><p>利用的思想是：减去一个数等于加上这个数的相反数，而求相反数的方法就是利用 2^w 溢出导致结果也可以看作 1 所以</p><p><img data-src="/images/csapp/screenshot-2025-04-13-230325.png" alt="屏幕截图 2025-04-13 230325"></p><p>求 x 的逆元的方法</p><p>**<mark> 有符号数的减法</mark></p><p><img data-src="/images/csapp/image-20250518141819479.png" alt="image-20250518141819479"></p><p>由于有符号数正负的不对称所以，最小值的逆元就是它本身</p><p>**<mark> 无符号数的乘法运算</mark></p><p>w 位数字相乘大概率是 2w 位但是会截断到 w 位</p><p>**<mark> 补码的乘法</mark></p><p>乘法左移即可，而除法无符号数右移即可，有符号要进行算术右移，但还有以一个注意的点是，负数右移截断之后通常会结果 - 1，如 - 7/4 正常结果是 - 1 而由于右移之后结果是 - 2，所以我们要加一个偏置而这个偏置的大小是 2^n-1 n 是右移位数</p><p>**<mark> 除法舍入问题</mark></p><p><img data-src="/images/csapp/image-20250518143021785.png" alt="image-20250518143021785"></p><p>补码除法为了向下取整所以需要在 &lt; 0 的情况下加一个偏置量计算方法是：<mark>（1 &lt;&lt;k）-1</mark>,k 为左移的位数。</p><h3 id="浮点数"><a class="anchor" href="#浮点数">#</a> 浮点数</h3><p><img data-src="/images/csapp/screenshot-2025-04-13-234334.png" alt="屏幕截图 2025-04-13 234334"></p><p>normalized 规格化的值</p><p>denormalized 非规格化的值 infinity 特殊值（表示无穷大或者无穷小或者不是一个数）</p><p>对于<mark>规格化的值</mark></p><p>float：<br><img data-src="/images/csapp/image-20250518144941906.png" alt="image-20250518144941906"></p><p>右上角是计算公式</p><p>而对于<mark>非规格化的值和特殊值建议看原书</mark></p><p>非规格化<mark> E=1-bias</mark>，<mark>M=0.fff</mark></p><p><mark>int 和 float 型的转换</mark></p><p><img data-src="/images/csapp/image-20250518151537696.png" alt="image-20250518151537696"></p><h2 id="程序的机器级表示"><a class="anchor" href="#程序的机器级表示">#</a> 程序的机器级表示</h2><p>调用者保存：</p><p><img data-src="/images/csapp/image-20250423100046973.png" alt="image-20250423100046973"></p><p>这里的 funA 是调用者函数，B 是被调用者而 % rbx 的存储的值在 A 中前后应该保持一致，所以我们在调用 B 函数之前保存 rbx 的值然后在调用结束之后再回复</p><p>被调用者策略：</p><p>就是再 funB 中操作在操作前后进行保存，然后在 ret（就是返回的）的前一步恢复 rbx 的值</p><h3 id="寄存器与数据传送指令"><a class="anchor" href="#寄存器与数据传送指令">#</a> 寄存器与数据传送指令</h3><p><img data-src="/images/csapp/image-20250423100839537.png" alt="image-20250423100839537"></p><p>内存引用：（）括号中为一个寄存器实际的含义就是<mark>机器将 rbx 中的值看作一个地址然后将这个地址中的内容存储到 rax 中</mark></p><p>操作数中（按 at&amp;t）后面是目的操作数，前面是源操作数，而目的操作数不可以是立即数</p><p><img data-src="/images/csapp/image-20250423102751632.png" alt="image-20250423102751632"></p><p>举个例子如果想要实现，一个数据从一个位置到另一个位置，我们的操作如上</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">//例如我们要把%rbx中指向地址的值放到%rdx中那么我们需要一个寄存器做中间传递</span><br><span class="line">mov (%rbx)  %rax   //内存引用就是把rbx中存储地址位置的值取出来放到rax中</span><br><span class="line">mov %rax  (%rdx)    //rax中的值放到rdx中存储地址位置上</span><br></pre></td></tr></table></figure><h3 id="栈中数据与传送指令"><a class="anchor" href="#栈中数据与传送指令">#</a> 栈中数据与传送指令</h3><p><img data-src="/images/csapp/image-20250423105750263.png" alt="image-20250423105750263"></p><p>在内存中就是我们一开始放的图片，栈是高地址向低地址生长的，而 push 操作其实是 rsp（栈顶指针 - 8）然后把 rax 中的值放到 rsp 指向的位置，pop 类似</p><h3 id="算术逻辑与逻辑运算指令"><a class="anchor" href="#算术逻辑与逻辑运算指令">#</a> 算术逻辑与逻辑运算指令</h3><p>leaq：加载有效地址</p><p><img data-src="/images/csapp/image-20250423110651314.png" alt="image-20250423110651314"></p><p>leaq 并不是要取地址中的值来赋值给 rax 而是单纯计算出一个值放到 rax 中，计算的方法同上</p><p><img data-src="/images/csapp/image-20250423111633188.png" alt="image-20250423111633188"></p><p>来实现乘法运算，比例因子只能是 1 2 4 8 所以不能直接 * 12</p><p><img data-src="/images/csapp/image-20250423111906308.png" alt="image-20250423111906308"></p><p>二元操作，第二个数既是源操作数也是目的操作数，<mark>所以它不能是一个立即数，只能是立即数或者寄存器</mark></p><p><img data-src="/images/csapp/image-20250423112455099.png" alt="image-20250423112455099"></p><p>移位运算，k 可以是立即数也可以是存储在 % cl 中的数<mark>移动的位数只看 cl 中的低 w 位</mark></p><h3 id="指令与条件码"><a class="anchor" href="#指令与条件码">#</a> 指令与条件码</h3><p><img data-src="/images/csapp/image-20250426150945558.png" alt="image-20250426150945558"></p><p>条件码寄存器：<br>CF：无符号数进位时，设置为 1</p><p>ZF：上一个条件执行完之后如果结果为 0，设置为 1</p><p>SF：语句 1 执行完为负时设置为 1</p><p>OF：有符号数溢出时设置为 1</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cmp和test指令</span><br><span class="line">cmpq %rax %rdx  //类似sub操作但是结果只存放在条件码寄存器之中对目的寄存器无影响</span><br><span class="line">test同add</span><br></pre></td></tr></table></figure><p><mark>* 接下来我们看如何用条件码来进行逻辑判断</mark></p><p><img data-src="/images/csapp/image-20250426152333071.png" alt="image-20250426152333071"></p><p>比较 ab 两个值是否相等，如果相等返回 1，不等则返回 0 sete 中的结尾 e 时 equal 的意思它代表的含义就是下面两条语句，之后再对 al 进行扩充位数</p><p>再来看一个复杂的将 a==b 修改为 a&lt;b</p><p><img data-src="/images/csapp/image-20250426152854892.png" alt="image-20250426152854892"></p><p>此时使用指令 setl 而这个指令实际上完成的操作是对符号位和溢出位取异或进行检查，原理如下如果 a-b 不发生溢出，那么符号位就是最终所要的真值，但是如果发生溢出<mark> case3 来看符号位为 0 但是 a 明显小于 b 这时候，sf 与最终真值不符，case4 也是这个道理</mark>所以我们进行一个异或操作来得到最终的真值</p><h3 id="不同寄存器小结"><a class="anchor" href="#不同寄存器小结">#</a> 不同寄存器小结</h3><ul><li>% rax (% eax) 用于做累加</li><li>% rcx (% ecx) 用于计数</li><li>% rdx (% edx) 用于保存数据</li><li>% rbx (% ebx) 用于做内存查找的基础地址</li><li>% rsi (% esi) 用于保存源索引值</li><li>% rdi (% edi) 用于保存目标索引值</li><li>% rip 始终保存<strong>下一条要执行指令的线性地址</strong>。</li></ul><h3 id="过程函数调用"><a class="anchor" href="#过程函数调用">#</a> 过程（函数调用）</h3><p>栈帧：函数执行所需要的空间远超出寄存器的大小，借助栈上的空间，这部分空间就成为栈帧</p><p>通过 call 指令调用函数，并且在执行函数之前要把返回地址压入栈中</p><p><mark>传递参数如果大于 6 需要用栈来传递参数，而用栈传递数据的大小需要向 8 的倍数对齐例如如果之占一个字节也需要分配 8 个字节的空间</mark></p><p><img data-src="/images/csapp/image-20250428101605633.png" alt="image-20250428101605633"></p><p>call 指令调用时要把下一条指令的地址传入栈中然后函数调用结束，这个返回地址弹栈存放在 rip 中，就可以实现返回 main 函数继续执行下面的指令</p><p><img data-src="/images/csapp/image-20250428102609404.png" alt="image-20250428102609404"></p><p>前六个参数不需要对其，后两个用栈传递需要对齐</p><p><mark>递归相对应汇编</mark></p><p><img data-src="/images/csapp/image-20250428105039740.png" alt="image-20250428105039740"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">rfact:</span><br><span class="line">    pushq   %rbx    </span><br><span class="line">    movq    %rdi, %rbx   //被调用者保存先把n保存在rbx中</span><br><span class="line">    movl    $1, %eax    //函数返回值是rax想当于计算result=1</span><br><span class="line">    cmpq    $1, %rdi   </span><br><span class="line">    jle     .L35    //如果&lt;= 跳转L35. 返回rax</span><br><span class="line">    leaq    -1(%rdi), %rdi   //否则先计算新的参数即n-1存放在rdi中</span><br><span class="line">    call    rfact       </span><br><span class="line">    imulq   %rbx, %rax   //call完的返回值存放在rax中再与n相乘然后返回</span><br><span class="line">.L35:</span><br><span class="line">    popq    %rbx</span><br><span class="line">    ret</span><br></pre></td></tr></table></figure><p><mark>简述 rbp 和 rsp</mark></p><figure class="highlight txt"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">高地址</span><br><span class="line">──────────────────────</span><br><span class="line">[ ... 上层调用者的栈帧 ... ]</span><br><span class="line">──────────────────────</span><br><span class="line">[ return RIP       ] ← 存在 call 指令自动 push 的返回地址</span><br><span class="line">──────────────────────</span><br><span class="line">[ old %rbp         ] ← pushq %rbp （RBP@entry）</span><br><span class="line">────────────────────── ← ← ← ← ← ← ←  ← movq %rsp,%rbp 后此处为 RBP</span><br><span class="line">↑                 ↑</span><br><span class="line">│                 │</span><br><span class="line">│    %rbp 栈帧基址  │</span><br><span class="line">│ (固定不动，用它作寻址基准)</span><br><span class="line">↓                 ↓</span><br><span class="line">──────────────────────</span><br><span class="line">[ 局部变量 #1      ] ← -8(%rbp)</span><br><span class="line">──────────────────────</span><br><span class="line">[ 局部变量 #2      ] ← -16(%rbp)</span><br><span class="line">──────────────────────</span><br><span class="line">[ … 更多局部 …    ] ← -offset(%rbp)</span><br><span class="line">────────────────────── ← ← ← ← ← ← ←  ← subq $N,%rsp 后此处为 %rsp 初始位置</span><br><span class="line">↑                 ↑</span><br><span class="line">│                 │</span><br><span class="line">│    %rsp 栈顶     │</span><br><span class="line">│ (动态移动，用它分配/释放栈空间)</span><br><span class="line">↓                 ↓</span><br><span class="line">低地址</span><br></pre></td></tr></table></figure><p>所以 rbp 不动通过对他正偏移和负偏移来访问参数和局部变量</p><h3 id="缓冲区溢出"><a class="anchor" href="#缓冲区溢出">#</a> 缓冲区溢出</h3><p>（把实验搞完就会了）</p><h2 id="linkers"><a class="anchor" href="#linkers">#</a> Linkers</h2><h3 id="须知"><a class="anchor" href="#须知">#</a> 须知</h3><ul><li><p>可重定位目标文件 Relocatable object file (.o file)</p><ul><li>每个 <code>.o</code> 文件都是由对应的 <code>.c</code> 文件通过编译器和汇编器生成，包含代码和数据，可以与其他可重定位目标文件合并创建一个可执行或共享的目标文件</li></ul></li><li><p>可执行目标文件 Executable object file（a.out file)</p><ul><li>由链接器生成，可以直接通过加载器加载到内存中充当进程执行的文件，包含代码和数据</li></ul></li><li><p>共享目标文件 Shared object file (.so file)</p><ul><li>在 windows 中被称为 Dynamic Link Libraries (DLLs)，是类特殊的可重定位目标文件，可以在链接 (静态共享库) 时加入目标文件或加载时或运行时 (动态共享库) 被动态的加载到内存并执行</li></ul></li><li><p>强符号：函数和初始化的全局变量</p></li><li><p>弱符号：未初始化的全局变量</p></li></ul><p>链接器在处理强弱符号的时候遵守以下规则：</p><ol><li>不能出现多个同名的强符号，不然就会出现链接错误</li><li>如果有同名的强符号和弱符号，选择强符号，也就意味着弱符号是『无效』d 而</li><li>如果有多个弱符号，随便选择一个</li></ol><p>例子：</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件 p1.c</span></span><br><span class="line"><span class="type">int</span> x; </span><br><span class="line"><span class="type">int</span> y;</span><br><span class="line">p1() &#123; ... &#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------------------------------------</span></span><br><span class="line"><span class="comment">// 文件 p2.c</span></span><br><span class="line"><span class="type">double</span> x;</span><br><span class="line">p2() &#123; ... &#125;</span><br></pre></td></tr></table></figure><p>这里 p1 和 p2 中定义的变量都是弱符号，我们对 p2 中的 x 进行写入时，居然可能会影响到 p1 中的 y！想想为什么？其实原因很简单，以为 x 实际上引用的是同一个地址，而 double 的字节数是 int 的两倍，所以 y 就『躺枪』了。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 文件 p1.c</span></span><br><span class="line"><span class="type">int</span> x = <span class="number">7</span>; </span><br><span class="line"><span class="type">int</span> y = <span class="number">4</span>;</span><br><span class="line">p1() &#123; ... &#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">// -----------------------------------------</span></span><br><span class="line"><span class="comment">// 文件 p2.c</span></span><br><span class="line"><span class="type">double</span> x;</span><br><span class="line">p2() &#123; ... &#125;</span><br></pre></td></tr></table></figure><p>这个例子是强弱符号间的引用了，p1 中的变量因为初始化的缘故，是强符号，所以在 p2 中引用 x 时，实际上操作的是 p1 中定义的全局变量的值，而因为 p2 中 x 是 double 类型，所以一旦进行改动，实际上就 p1 中 x 和 y 都会受到影响。</p><h3 id="elf主要内容"><a class="anchor" href="#elf主要内容">#</a> ELF 主要内容</h3><p><img data-src="/images/csapp/image-20250512110855764.png" alt="image-20250512110855764"></p><ul><li>ELF header<ul><li>包含 word size, byte ordering, file type (.o, exec, .so), machine type, etc</li></ul></li><li>Segment header table<ul><li>包含 page size, virtual addresses memory segments (sections), segment sizes</li></ul></li><li>.text section<ul><li>代码部分</li></ul></li><li>.rodata section<ul><li>只读数据部分，例如跳转表</li></ul></li><li>.data section<ul><li>初始化的全局变量</li></ul></li><li>.bss section<ul><li>未初始化的全局变量</li></ul></li><li>.symtab section<ul><li>包含 symbol table, procudure 和 static variable names 以及 section names 和 location</li></ul></li><li>.rel.txt section<ul><li>.text section 的重定位信息</li></ul></li><li>.rel.data section<ul><li>.data section 的重定位信息</li></ul></li><li>.debug section<ul><li>包含 symbolic debugging ( <code>gcc -g</code> ) 的信息</li></ul></li><li>Section header table<ul><li>每个 section 的大小和偏移量</li></ul></li></ul><h3 id="重定位"><a class="anchor" href="#重定位">#</a> 重定位</h3><h2 id="处理器体系结构"><a class="anchor" href="#处理器体系结构">#</a> 处理器体系结构</h2><h3 id="指令系统"><a class="anchor" href="#指令系统">#</a> 指令系统</h3><p>用一种简单的 Y86 指令系统</p><p><img data-src="/images/csapp/image-20250525144114828.png" alt="image-20250525144114828"></p><p>以上是 mov 的四种指令，高位的第一个字节高四位表示操作码，第四位表示实现功能（例如图中都是 0 代表实现 mov 操作）</p><p><mark>因为 Y86 中定义了 15 个寄存器，所以编号是 0x0~0xe，所以如图第二行中 F 表示的是没有寄存器</mark></p><p><strong>整数操作指令</strong></p><p><img data-src="/images/csapp/image-20250525144811806.png" alt="image-20250525144811806"></p><p>功能部分不同</p><h3 id="逻辑门"><a class="anchor" href="#逻辑门">#</a> 逻辑门</h3><p>（等到大二学数字电路）</p><h3 id="指令的顺序实现"><a class="anchor" href="#指令的顺序实现">#</a> 指令的顺序实现</h3><p><img data-src="/images/csapp/image-20250525151415378.png" alt="image-20250525151415378"></p><p>cpu 执行的操作</p><p>Decode，Write Back 针对寄存的读入与写的两个操作，Execute 是对 ALU 的操作（3 种），而 Memory 是对内存的读入和写入操作。Update 就是把 pc 设置成下一条指令的地址</p><p><img data-src="/images/csapp/image-20250525153107462.png" alt="image-20250525153107462"></p><p>跳转指令执行阶段通过对条件码的计算来确定是否要进行跳转指令</p><h3 id="各个阶段的硬件实现"><a class="anchor" href="#各个阶段的硬件实现">#</a> 各个阶段的硬件实现</h3><p><strong>Fetch</strong></p><p>以 pc 的值为起始地址取 10bytes 内容（因为 y86 中最长指令为 10 字节），之后分为两个部分一部分为 1 字节另一部分为 9 字节，1 字节内容高四位和第四位分为指令代码和指令功能</p><p><img data-src="/images/csapp/image-20250527081006193.png" alt="image-20250527081006193"></p><p>icode 部分可以用来判断是否指令合法，需要寄存器数量和是否存在常数 C，这样的话就可以决定这条指令的长度，之后 PC 加上这个长度就是下一条指令的的起始</p><p>如果需要两个寄存器的话，Align 第一个字节的高四位和第四位分别存入 rA 和 rB，如果只需要一个寄存器那么另一个会设置为 0xF。</p><p>当 Need_regids==1 时，Align 的 2~9 字节表示常数 C; 当它值为 0 时，Align 的 1-8 字节表示常数</p><p><strong>Decode Stage</strong></p><p><img data-src="/images/csapp/image-20250527081756967.png" alt="image-20250527081756967"></p><p>用 icode 来判断是否需要 rsp 的值，右边四条指令中只出现一个寄存器但在实际调用时还需要知道 rsp 的值，所以用 icode 来判断</p><p><strong>Execute</strong></p><p><img data-src="/images/csapp/image-20250527082423154.png" alt="image-20250527082423154"></p><p>CC 为条件码，我们只在算术逻辑运算中更新 CC，所以当指令是对<mark>内存引用地址的运算</mark>，或者<mark>栈的操作时</mark>，CC 不更新。</p><p>Cond 由 ifun 和 CC 来产生一个值（针对跳转指令），当 cnd==1，跳转否则不跳转</p><p><strong>Memory Stage</strong></p><p><img data-src="/images/csapp/image-20250527083452341.png" alt="image-20250527083452341"></p><p>通过计算来得到 Stat 值</p><p><strong>Write Back Stage</strong></p><p><img data-src="/images/csapp/screenshot-2025-05-27-083622.png" alt="屏幕截图 2025-05-27 083622"></p><p>遇到 cmov 之类的指会取决于 cnd 的值，如果为 1 执行指令，当为 1 时<mark>会设置寄存器为 0xF 来禁止写入</mark></p><p><strong>PC 值的更新</strong></p><p><img data-src="/images/csapp/image-20250527084018750.png" alt="image-20250527084018750"></p><p>4 种更新 pc 情况</p><h3 id="流水线的通用原理"><a class="anchor" href="#流水线的通用原理">#</a> 流水线的通用原理</h3><p><img data-src="/images/csapp/image-20250527090600033.png" alt="image-20250527090600033"></p><p>当时钟寄存器处于高电位时，寄存器值才会更新</p><h3 id="流水线的硬件实现"><a class="anchor" href="#流水线的硬件实现">#</a> 流水线的硬件实现</h3><p><strong>SEQ+：电路重定时</strong></p><p><img data-src="/images/csapp/image-20250527092659323.png" alt="image-20250527092659323"></p><p>引入 5 个寄存器，和上面一样构造流水线，不同的是把第一个寄存器存放 PredPC 值（预测）</p><h3 id="数据冒险"><a class="anchor" href="#数据冒险">#</a> 数据冒险</h3><p>指令之间有连接性，下一体指令往往需要上一条指令的结果</p><p><img data-src="/images/csapp/image-20250530131127772.png" alt="image-20250530131127772"></p><p>例如上图的指令</p><p>第三条指令在 decode 阶段由于上面两个指令的 write 还没有执行，直接 decode 第三条导致实际作用产生偏差</p><p>对此我们可以引入 bubble 来实现</p><p><img data-src="/images/csapp/image-20250530131251082.png" alt="image-20250530131251082"></p><p>此时在执行 add 操作的 decode 阶段上面两个操作的写回部分已经完成，但是依然存在很大的问题，加入很多 bubble 导致效率降低，所以我们引入另一种方法<mark>数据转发</mark></p><p>可以看到我们可以让上面的指令不经过寄存器直接把第三条需要的立即数直接放在 add 指令中，所以在设计中进入 == 至于实现方法就是在计算阶段中 alu 执行结果传输到 decode 阶段（具体实现过程不需要知道）</p><p>所以我们可以通过 bubble 和数据转发提升效率，而一般的程序指令也是通过这两种方法组合实现</p><h3 id="控制冒险"><a class="anchor" href="#控制冒险">#</a> 控制冒险</h3><p>正常情况下一个循环需要找到下一条的 pc 指令，进入流水，但是如果遇到 ret 指令那我们必须在执行完这条的 5 个部分才能从栈中找到所需要的，或者遇到条件跳转指令，我们需要上面代码执行之后的结果才能判断，那么这就是控制冒险</p><p>ret 进入访存阶段之后我们才可以执行下面的指令，所以急促通过暂停</p><p><img data-src="/images/csapp/image-20250530132759935.png" alt="image-20250530132759935"></p><p>跳转指令</p><p><img data-src="/images/csapp/image-20250530133521577.png" alt="image-20250530133521577"></p><p>对左边代码做出解释，这是简化过的<mark>如果跳转 target 函数内部要执行接下来的两条 irmovq 指令，如果不跳转执行第三条 irmovq 指令</mark></p><p>条件预测的过程比较复杂，但我们假设机器对于所有的预测都是执行，所以当我们遇到 jne 直接下一个周期塞入第一条 irmovq 指令，接下来周期再放入一条 movq 指令，好下一个周期到了第五个周期 jne 指令已经计算完成，如果现在我们发现结果是不跳转，那么我们现在的任务是删除这两条指令，我们采用的方法是<mark>在第五个周期第三条指令的执行阶段放入 bubble，第六周期对第四条指令实行同样的操作</mark>，接着不跳转的指令进入流水。</p><h2 id="优化程序性能"><a class="anchor" href="#优化程序性能">#</a> 优化程序性能</h2><h3 id="程序优化的局限性"><a class="anchor" href="#程序优化的局限性">#</a> 程序优化的局限性</h3><p>1. 内存别名引用：例如指针指向相同的位置和不同的位置，在优化前后产生了不同的效果，这种优化由于不安全所以无法采用</p><p><img data-src="/images/csapp/image-20250606132806318.png" alt="image-20250606132806318"></p><p>例如，在大多数情况下 add1 执行六次取址，而 add2 只执行三次，效率是大于下面的但是如果是 xy yp 指向的内存一致的情况，会导致最终的结果不一致，所以这种优化不可以使用</p><p>2. 函数调用</p><p><img data-src="/images/csapp/image-20250606133215506.png" alt="image-20250606133215506"></p><p>counter 是一种全局变量而 func1 和 func2 完全效果不一致，所以不可以优化为 2</p><p>度量程序性能，我们引入<mark> CPE</mark>（每个元素所要执行的周期数）</p><h3 id="优化程序性能-2"><a class="anchor" href="#优化程序性能-2">#</a> 优化程序性能</h3><p><strong>代码移动</strong></p><p><img data-src="/images/csapp/image-20250606134352331.png" alt="image-20250606134352331"></p><p>减少了函数 strlen 的调用可以减少大量的时间</p><p><strong>减少内存引用的次数</strong></p><p><img data-src="/images/csapp/image-20250606135328276.png" alt="image-20250606135328276"></p><p><img data-src="/images/csapp/image-20250606135259030.png" alt="image-20250606135259030"></p><p>每次累计值需要取址，写入，当我们改用加入一个临时变量的时候，效率可以大大提升</p><h3 id="现代处理器"><a class="anchor" href="#现代处理器">#</a> 现代处理器</h3><p>ICU（<mark>指令控制单元</mark>：从内存中读取指令序列），EU（<mark>执行单元</mark>）</p><p><img data-src="/images/csapp/image-20250610083719434.png" alt="image-20250610083719434"></p><h3 id="数据流图"><a class="anchor" href="#数据流图">#</a> 数据流图</h3><p><img data-src="/images/csapp/image-20250610084449105.png" alt="image-20250610084449105"></p><p>我们将右图的四条汇编指令，可以翻译为左边的五个操作，那么我们可以将寄存器分为四类：</p><p><strong>只读</strong>：寄存器作为源值，可作为数据 / 地址，但在执行中不会被修改</p><p><strong>只写</strong>：只写入数据的寄存器，这个程序内无</p><p><strong>局部</strong>：比如条件寄存器，只在循环内部修改和使用，每一次迭代之间不相关</p><p><strong>循环</strong>：可以作为源值也可以作为目的，每一次迭代需要上一次迭代的值</p><p><img data-src="/images/csapp/image-20250610085641460.png" alt="image-20250610085641460"></p><p>因为在程序执行中分支预测功能，所以判断指令可以简化掉，简化之后的操作可以抽象为左图，当循环次数为 n 时就可以形成右图的循环链路，左侧为累积相乘右图为下标变换，而制约程序执行速度的就是左侧的浮点数乘法</p><h3 id="循环展开"><a class="anchor" href="#循环展开">#</a> 循环展开</h3><p><img data-src="/images/csapp/image-20250610204213640.png" alt="image-20250610204213640"></p><p>这是我们之前对于一个程序的优化，我们称之为<mark> 2*1 循环展开</mark>，（2 代表每次循环处理两个数组元素），但是我们从 CPE 中测定得到对于 int 加法类型确实性能有提升（循环次数减少的作用），但是对于其他情况性能提升的作用很弱，那么增加每次循环处理的数组元素个数是否能提升性能呢。</p><p><img data-src="/images/csapp/image-20250610204555399.png" alt="image-20250610204555399"></p><p>这是汇编相应的实现过程，我们可以发现即使循环次数的减少但在执行过程中 mul 操作执行的次数并没有改变，所以提高单词的循环处理数组元素也不能达到我们的目的。</p><p><img data-src="/images/csapp/image-20250610205030926.png" alt="image-20250610205030926"></p><p>我们新的程序中采用的了<mark> 2*2 两路并行展开</mark>，将偶数下标存储在 acc0 中奇数存储在 acc1 中，最后再将两者相加。</p><p>观察汇编我们发现</p><p><img data-src="/images/csapp/image-20250610205253070.png" alt="image-20250610205253070"></p><p>寄存器使用了两个寄存器来并行，简化后的流程就是右侧的图，大大提升了效率。而不断增加并行的寄存器，CPE 会减小，但是我们要注意<mark>当超出寄存器的个数，导致将传入栈中时</mark>，此时程序的执行效率可能会改变。</p><p>另一种提升执行效率的方法：</p><p><strong>改变 acc 的合并顺序</strong></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">combine5:</span><br><span class="line">acc = (acc OP data[i]) OP data[i+<span class="number">1</span>]</span><br><span class="line">combine7:</span><br><span class="line">acc = acc OP (data[i] OP data[i+<span class="number">1</span>])</span><br></pre></td></tr></table></figure><p><img data-src="/images/csapp/image-20250610210415771.png" alt="image-20250610210415771"></p><p>我们可以知道先合并的两个数据不需要等待之前迭代的部分，也就是主链路中只有 n/2 个 mul 这也是效率提升的原因</p><h2 id="存储器层次结构"><a class="anchor" href="#存储器层次结构">#</a> 存储器层次结构</h2><h3 id="存储技术"><a class="anchor" href="#存储技术">#</a> 存储技术</h3><p>Cache 是 SRAM, 造价更贵，但更稳定</p><p><img data-src="/images/csapp/image-20250614222419476.png" alt="image-20250614222419476"></p><p>Controller 输入 2 指令在 chip 中取第二行的数据到缓冲区中</p><p><img data-src="/images/csapp/image-20250614222632437.png" alt="image-20250614222632437"></p><p>之后再输入 columns 为 1，从缓冲区中取 1 传输到 Memory</p><h3 id="缓存cache"><a class="anchor" href="#缓存cache">#</a> 缓存（Cache）</h3><p><strong>Cache hit</strong>：<br>当从 K+1 层中找 d 这个数据时，我们先从第 k 层中寻找，如果 d 刚好在 k 层中，我们称这种情况为缓存命中，反之称为缓存不命中（Cache miss）</p><p><mark>若发生缓存不命中的情况时，第 k 层中缓存从 K+1 层中取出目标数据块，如果 k 层已满那么会覆盖其中的块（替换策略有：随机替换和 LRU 等）</mark></p><p><strong>Cache 的内部结构</strong></p><p><img data-src="/images/csapp/image-20250614225642835.png" alt="image-20250614225642835"></p><p>Cache 有 S 个 set，每个 set 中有 E 个 line，每个 line 中分为三部分分别是 Valid（判断数据是否有效），tag 标记（<mark>用来确定目标数据是否在当前的 Cache line 中</mark>），之后的 B 位就是数据位了，所以一个 Cache 的空间可以用右边的公式来计算大小。</p><p><strong>Cache 的工作过程</strong>：CPU 执行从内存地址 A 中读取数据时，将地址 A 发送到 Cache</p><h3 id="直接映射高速缓存"><a class="anchor" href="#直接映射高速缓存">#</a> 直接映射高速缓存</h3><p><strong>组选择</strong></p><p>CPU 发送的地址中</p><p><img data-src="/images/csapp/image-20250615133636766.png" alt="image-20250615133636766"></p><p>从组索引位决定 Set 的标号（<mark>关于组索引位为什么不选择高位而是选择地址的中间部分，我们随后做出解释</mark>），接着我们取出相应的 Cache line</p><p><strong>行匹配</strong></p><p><img data-src="/images/csapp/image-20250615134036341.png" alt="image-20250615134036341"></p><p>特定行 Cache hit 的条件有两个，一个是有效值是否为 1，另一个是 Tag 是否匹配如果匹配根据 Block offset 的字节偏移数来取出相应的数据（例如 100 指明偏移量为 4 则从 4 开始取剩下的字节）</p><p><strong>冲突不命中</strong></p><p>由于数组映射的 Cache 位置相同使某个 set 一直在变化导致效率低下的问题（详细看视频看懂这个问题即可）</p><p>具体的解决措施就是改变数组的长度使映射的 set 不同来消除<mark>抖动</mark></p><h3 id="组相联和全相联cache"><a class="anchor" href="#组相联和全相联cache">#</a> 组相联和全相联 Cache</h3><p><img data-src="/images/csapp/image-20250615140035770.png" alt="image-20250615140035770"></p><p>还是需要三个阶段来取数据不同的使在行匹配中需要遍历每个 Set 找到 Tag 和有效值都符合要求的 line</p><p>如果不命中则需要把内存中的一行写入这个 set 中，最好的替换位置是 valid 为 0 的空行，如果不满足则需要一些替换策略来替换已经写入的行中</p><p>替换策略（随机替换，最不常用替换，最近使用最少策略）</p><p><strong>全相联</strong><br>整个 Cache 只有一个 set</p></div><footer><div class="meta"><span class="item"><span class="icon"><i class="ic i-calendar-check"></i> </span><span class="text">Edited on</span> <time title="Modified: 2025-08-02 20:45:18" itemprop="dateModified" datetime="2025-08-02T20:45:18+08:00">2025-08-02</time></span></div><div id="copyright"><ul><li class="author"><strong>Post author: </strong>XYK <i class="ic i-at"><em>@</em></i>XYK的博客</li><li class="link"><strong>Post link: </strong><a href="https://ks-superbig.github.io/2025/08/02/CSAPP/" title="CSAPP">https://ks-superbig.github.io/2025/08/02/CSAPP/</a></li><li class="license"><strong>Copyright Notice: </strong>All articles in this blog are licensed under <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> unless stating additionally.</li></ul></div></footer></article></div><div class="post-nav"><div class="item left"><a href="/2025/07/03/hello-world/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;tva3.sinaimg.cn&#x2F;large&#x2F;6833939bly1gicitht3xtj20zk0m8k5v.jpg" title="Hello World"><span class="type">Previous Post</span> <span class="category"><i class="ic i-flag"></i></span><h3>Hello World</h3></a></div><div class="item right"></div></div><div class="wrap" id="comments"></div></div><div id="sidebar"><div class="inner"><div class="panels"><div class="inner"><div class="contents panel pjax" data-title="Contents"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#csapp"><span class="toc-number">1.</span> <span class="toc-text">CSAPP</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#labs"><span class="toc-number">1.1.</span> <span class="toc-text">labs</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#bomb"><span class="toc-number">1.1.1.</span> <span class="toc-text">bomb</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#arm%E7%89%88%E6%9C%AC"><span class="toc-number">1.1.2.</span> <span class="toc-text">arm 版本</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#buffer"><span class="toc-number">1.1.3.</span> <span class="toc-text">buffer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BA%8F%E7%AB%A0"><span class="toc-number">1.2.</span> <span class="toc-text">序章</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E7%9A%84%E8%A1%A8%E7%A4%BA%E4%B8%8E%E5%A4%84%E7%90%86"><span class="toc-number">1.3.</span> <span class="toc-text">信息的表示与处理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BF%A1%E6%81%AF%E7%9A%84%E5%AD%98%E5%82%A8"><span class="toc-number">1.3.1.</span> <span class="toc-text">信息的存储：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E6%95%B0%E7%9A%84%E8%A1%A8%E7%A4%BA"><span class="toc-number">1.3.2.</span> <span class="toc-text">整数的表示</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B4%E6%95%B0%E7%9A%84%E8%BF%90%E7%AE%97"><span class="toc-number">1.3.3.</span> <span class="toc-text">整数的运算</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%AE%E7%82%B9%E6%95%B0"><span class="toc-number">1.3.4.</span> <span class="toc-text">浮点数</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E7%9A%84%E6%9C%BA%E5%99%A8%E7%BA%A7%E8%A1%A8%E7%A4%BA"><span class="toc-number">1.4.</span> <span class="toc-text">程序的机器级表示</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AF%84%E5%AD%98%E5%99%A8%E4%B8%8E%E6%95%B0%E6%8D%AE%E4%BC%A0%E9%80%81%E6%8C%87%E4%BB%A4"><span class="toc-number">1.4.1.</span> <span class="toc-text">寄存器与数据传送指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%A0%88%E4%B8%AD%E6%95%B0%E6%8D%AE%E4%B8%8E%E4%BC%A0%E9%80%81%E6%8C%87%E4%BB%A4"><span class="toc-number">1.4.2.</span> <span class="toc-text">栈中数据与传送指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%97%E6%9C%AF%E9%80%BB%E8%BE%91%E4%B8%8E%E9%80%BB%E8%BE%91%E8%BF%90%E7%AE%97%E6%8C%87%E4%BB%A4"><span class="toc-number">1.4.3.</span> <span class="toc-text">算术逻辑与逻辑运算指令</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E4%B8%8E%E6%9D%A1%E4%BB%B6%E7%A0%81"><span class="toc-number">1.4.4.</span> <span class="toc-text">指令与条件码</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E5%90%8C%E5%AF%84%E5%AD%98%E5%99%A8%E5%B0%8F%E7%BB%93"><span class="toc-number">1.4.5.</span> <span class="toc-text">不同寄存器小结</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B%E5%87%BD%E6%95%B0%E8%B0%83%E7%94%A8"><span class="toc-number">1.4.6.</span> <span class="toc-text">过程（函数调用）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA"><span class="toc-number">1.4.7.</span> <span class="toc-text">缓冲区溢出</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linkers"><span class="toc-number">1.5.</span> <span class="toc-text">Linkers</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%A1%BB%E7%9F%A5"><span class="toc-number">1.5.1.</span> <span class="toc-text">须知</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#elf%E4%B8%BB%E8%A6%81%E5%86%85%E5%AE%B9"><span class="toc-number">1.5.2.</span> <span class="toc-text">ELF 主要内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%87%8D%E5%AE%9A%E4%BD%8D"><span class="toc-number">1.5.3.</span> <span class="toc-text">重定位</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%A4%84%E7%90%86%E5%99%A8%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84"><span class="toc-number">1.6.</span> <span class="toc-text">处理器体系结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E7%B3%BB%E7%BB%9F"><span class="toc-number">1.6.1.</span> <span class="toc-text">指令系统</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%80%BB%E8%BE%91%E9%97%A8"><span class="toc-number">1.6.2.</span> <span class="toc-text">逻辑门</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8C%87%E4%BB%A4%E7%9A%84%E9%A1%BA%E5%BA%8F%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.3.</span> <span class="toc-text">指令的顺序实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%84%E4%B8%AA%E9%98%B6%E6%AE%B5%E7%9A%84%E7%A1%AC%E4%BB%B6%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.4.</span> <span class="toc-text">各个阶段的硬件实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF%E7%9A%84%E9%80%9A%E7%94%A8%E5%8E%9F%E7%90%86"><span class="toc-number">1.6.5.</span> <span class="toc-text">流水线的通用原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%B5%81%E6%B0%B4%E7%BA%BF%E7%9A%84%E7%A1%AC%E4%BB%B6%E5%AE%9E%E7%8E%B0"><span class="toc-number">1.6.6.</span> <span class="toc-text">流水线的硬件实现</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E5%86%92%E9%99%A9"><span class="toc-number">1.6.7.</span> <span class="toc-text">数据冒险</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8E%A7%E5%88%B6%E5%86%92%E9%99%A9"><span class="toc-number">1.6.8.</span> <span class="toc-text">控制冒险</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD"><span class="toc-number">1.7.</span> <span class="toc-text">优化程序性能</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%A8%8B%E5%BA%8F%E4%BC%98%E5%8C%96%E7%9A%84%E5%B1%80%E9%99%90%E6%80%A7"><span class="toc-number">1.7.1.</span> <span class="toc-text">程序优化的局限性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E7%A8%8B%E5%BA%8F%E6%80%A7%E8%83%BD-2"><span class="toc-number">1.7.2.</span> <span class="toc-text">优化程序性能</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%B0%E4%BB%A3%E5%A4%84%E7%90%86%E5%99%A8"><span class="toc-number">1.7.3.</span> <span class="toc-text">现代处理器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%B0%E6%8D%AE%E6%B5%81%E5%9B%BE"><span class="toc-number">1.7.4.</span> <span class="toc-text">数据流图</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BE%AA%E7%8E%AF%E5%B1%95%E5%BC%80"><span class="toc-number">1.7.5.</span> <span class="toc-text">循环展开</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E5%99%A8%E5%B1%82%E6%AC%A1%E7%BB%93%E6%9E%84"><span class="toc-number">1.8.</span> <span class="toc-text">存储器层次结构</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AD%98%E5%82%A8%E6%8A%80%E6%9C%AF"><span class="toc-number">1.8.1.</span> <span class="toc-text">存储技术</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BC%93%E5%AD%98cache"><span class="toc-number">1.8.2.</span> <span class="toc-text">缓存（Cache）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%B4%E6%8E%A5%E6%98%A0%E5%B0%84%E9%AB%98%E9%80%9F%E7%BC%93%E5%AD%98"><span class="toc-number">1.8.3.</span> <span class="toc-text">直接映射高速缓存</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%84%E7%9B%B8%E8%81%94%E5%92%8C%E5%85%A8%E7%9B%B8%E8%81%94cache"><span class="toc-number">1.8.4.</span> <span class="toc-text">组相联和全相联 Cache</span></a></li></ol></li></ol></li></ol></div><div class="related panel pjax" data-title="Related"></div><div class="overview panel" data-title="Overview"><div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person"><img class="image" itemprop="image" alt="XYK" data-src="/images/avatar.jpg"><p class="name" itemprop="name">XYK</p><div class="description" itemprop="description"></div></div><nav class="state"><div class="item posts"><a href="/archives/"><span class="count">2</span> <span class="name">posts</span></a></div></nav><div class="social"></div><ul class="menu"><li class="item"><a href="/" rel="section"><i class="ic i-home"></i>Home</a></li></ul></div></div></div><ul id="quick"><li class="prev pjax"></li><li class="up"><i class="ic i-arrow-up"></i></li><li class="down"><i class="ic i-arrow-down"></i></li><li class="next pjax"></li><li class="percent"></li></ul></div></div><div class="dimmer"></div></div></main><footer id="footer"><div class="inner"><div class="widgets"><div class="rpost pjax"><h2>Random Posts</h2><ul><li class="item"><div class="breadcrumb"></div><span><a href="/2025/07/03/hello-world/" title="Hello World">Hello World</a></span></li><li class="item"><div class="breadcrumb"></div><span><a href="/2025/08/02/CSAPP/" title="CSAPP">CSAPP</a></span></li></ul></div><div><h2>Recent Comments</h2><ul class="leancloud-recent-comment"></ul></div></div><div class="status"><div class="copyright">&copy; 2010 – <span itemprop="copyrightYear">2025</span> <span class="with-love"><i class="ic i-sakura rotate"></i> </span><span class="author" itemprop="copyrightHolder">XYK @ XYK的博客</span></div><div class="powered-by">Powered by <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span></div></div></div></footer></div><script data-config type="text/javascript">var LOCAL={path:"2025/08/02/CSAPP/",favicon:{show:"（●´3｀●）Goooood",hide:"(´Д｀)Booooom"},search:{placeholder:"Search for Posts",empty:"We didn't find any results for the search: ${query}",stats:"${hits} results found in ${time} ms"},valine:!0,fancybox:!0,copyright:'Copied to clipboard successfully! <br> All articles in this blog are licensed under <i class="ic i-creative-commons"></i>BY-NC-SA.',ignores:[function(e){return e.includes("#")},function(e){return new RegExp(LOCAL.path+"$").test(e)}]}</script><script src="https://cdn.polyfill.io/v2/polyfill.js"></script><script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script><script src="/js/app.js?v=0.2.5"></script></body></html>